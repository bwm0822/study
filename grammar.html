<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文法範例整理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .section-anchor{ scroll-margin-top: 72px; } /* 捲動時避免被導覽列擋住 */
    [data-say]{ cursor:pointer; transition: transform .08s ease, background-color .2s ease, box-shadow .2s ease; }
    [data-say]:hover{ background-color: rgba(var(--bs-light-rgb), .06); }
    [data-say]:active{ transform: scale(1.02); }
    .speaking{ outline:2px solid var(--bs-primary); box-shadow: inset 0 0 0 .25rem rgba(var(--bs-primary-rgb), .2); }
    /* 階層縮排：章節 0、項目 ms-3、範例 ms-5（用 Bootstrap 間距工具） */
  </style>
</head>
<body>
  <!-- 導覽列 -->
  <nav class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary-subtle">
    <div class="container d-flex align-items-center gap-2">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand mb-0 h1">文法範例整理</span>

      <!-- 右側：章節跳轉（改用 Bootstrap Dropdown，而非 <select>） -->
      <div class="ms-auto dropdown">
        <button id="jumpBtn" class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                data-bs-toggle="dropdown" aria-expanded="false">
          跳至章節…
        </button>
        <ul id="jumpMenu" class="dropdown-menu dropdown-menu-end dropdown-menu-dark border border-secondary-subtle shadow">
          <!-- JS 會動態塞入章節項目 -->
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-3" id="main"></main>

  <!-- Bootstrap JS（dropdown 需要） -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== 語音（英文） ===== */
    const EN_LANG = 'en-US';
    let voices = [];
    function loadVoices(){ voices = speechSynthesis.getVoices(); }
    loadVoices();
    if ('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = loadVoices;

    function pickEnVoice(){
      const list = voices || [];
      return list.find(v => (v.lang||'').toLowerCase()==='en-us')
          || list.find(v => (v.lang||'').toLowerCase().startsWith('en'))
          || null;
    }
    function speakEn(text, ondone){
      if(!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = EN_LANG;
      const v = pickEnVoice(); if (v) u.voice = v;
      u.rate = 1; u.pitch = 1; u.volume = 1;
      u.onend = ()=> ondone && ondone();
      u.onerror = ()=> ondone && ondone();
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    /* ===== 解析 grammar.txt =====
       章節（行尾冒號）
           1. 子項目
               英文
               中文
    ================================= */
    function parseGrammar(txt){
      const lines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n');
      const sections = [];
      let curSec = null, curRule = null, pendingEn = null;

      const headingRe = /^([^\s].*?):\s*$/;      // 章節
      const ruleRe    = /^\s*\d+\.\s*(.+?)\s*$/; // 項目

      const flushPending = () => pendingEn = null;

      for (const raw of lines){
        const t = raw.trim();
        if (!t || t.startsWith('#')) continue;

        const mH = t.match(headingRe);
        if (mH){
          curSec = { title: mH[1], rules: [] };
          sections.push(curSec);
          curRule = null; flushPending(); continue;
        }

        const mR = t.match(ruleRe);
        if (mR){
          if (!curSec){ curSec = { title: '未命名章節', rules: [] }; sections.push(curSec); }
          curRule = { label: t, examples: [] }; // 顯示原始 "1. xxx"
          curSec.rules.push(curRule);
          flushPending(); continue;
        }

        // 例句 EN -> ZH 配對
        if (!curRule){
          if (!curSec){ curSec = { title: '未命名章節', rules: [] }; sections.push(curSec); }
          curRule = { label: '1. 其他', examples: [] };
          curSec.rules.push(curRule);
        }
        const isEnglish = /[A-Za-z]/.test(t) && !/[\u4E00-\u9FFF]/.test(t);
        if (isEnglish){
          if (pendingEn){ curRule.examples.push({ en: pendingEn, zh: '' }); }
          pendingEn = t;
        }else{
          if (pendingEn){ curRule.examples.push({ en: pendingEn, zh: t }); flushPending(); }
          else { curRule.examples.push({ en: '', zh: t }); }
        }
      }
      if (pendingEn && curRule){ curRule.examples.push({ en: pendingEn, zh: '' }); }
      return sections;
    }

    /* ===== 渲染 ===== */
    const $main = document.getElementById('main');
    const $jumpBtn  = document.getElementById('jumpBtn');
    const $jumpMenu = document.getElementById('jumpMenu');

    function render(sections){
      // 先清空下拉選單
      $jumpMenu.innerHTML = '';

      // 內容
      $main.innerHTML = '';
      sections.forEach((sec, i)=>{
        const id = 'sec_' + (i+1);

        // 下拉項目
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.className = 'dropdown-item';
        a.href = '#';
        a.dataset.target = id;
        a.textContent = sec.title;
        li.appendChild(a);
        $jumpMenu.appendChild(li);

        // 章節卡片
        const card = document.createElement('div');
        card.className = 'card bg-dark text-light border-secondary-subtle shadow-sm mb-3';

        const body = document.createElement('div');
        body.className = 'card-body';

        // 章節（用 h6 略小）
        const h = document.createElement('h6');
        h.id = id;
        h.className = 'section-anchor fw-semibold mb-3';
        h.textContent = sec.title;
        body.appendChild(h);

        // 項目 + 範例（以 Bootstrap 間距縮排）
        sec.rules.forEach(rule=>{
          // 項目：ms-3 縮排、字重
          const item = document.createElement('div');
          item.className = 'ms-3 fw-semibold mb-2';
          item.textContent = rule.label;
          body.appendChild(item);

          // 範例：更深一層縮排 ms-5；中文用次要色
          rule.examples.forEach(ex=>{
            const exWrap = document.createElement('div');
            exWrap.className = 'ms-5 mb-2';

            if (ex.en){
              const en = document.createElement('div');
              en.className = 'lh-sm';
              en.dataset.say = ex.en;
              en.dataset.lang = 'en';
              en.textContent = ex.en;
              exWrap.appendChild(en);
            }
            if (ex.zh){
              const zh = document.createElement('div');
              zh.className = 'text-secondary small';
              zh.textContent = ex.zh;
              exWrap.appendChild(zh);
            }
            body.appendChild(exWrap);
          });
        });

        card.appendChild(body);
        $main.appendChild(card);
      });
    }

    /* ===== 事件 ===== */
    document.getElementById('backBtn').addEventListener('click', ()=> history.back());

    // 點 dropdown 的章節項目：捲到該章節，並把按鈕文字恢復為 placeholder
    $jumpMenu.addEventListener('click', (e)=>{
      const a = e.target.closest('.dropdown-item');
      if (!a) return;
      e.preventDefault();

      const id = a.dataset.target;
      const target = document.getElementById(id);
      if (target) target.scrollIntoView({ behavior:'smooth', block:'start' });

      // 關閉 dropdown 並恢復文字
      const dd = bootstrap.Dropdown.getOrCreateInstance($jumpBtn);
      dd.hide();
      $jumpBtn.textContent = '跳至章節…';
      $jumpBtn.blur();
    });

    // 點英文發音
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-say]');
      if (!el) return;
      const isEn = (el.dataset.lang||'').toLowerCase().startsWith('en');
      if (!isEn) return;
      const text = el.dataset.say || el.textContent || '';
      el.classList.add('speaking');
      speakEn(text, ()=> el.classList.remove('speaking'));
    });

    /* ===== 載入資料 ===== */
    (async function(){
      try{
        const res = await fetch('content/grammar.txt?c=' + Date.now());
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const sections = parseGrammar(text);
        render(sections);
      }catch(err){
        console.error(err);
        $main.innerHTML = `
          <div class="alert alert-danger" role="alert">
            讀取失敗：${String(err.message||err)}
          </div>`;
        // 失敗時 dropdown 保持原樣
      }
    })();
  </script>
</body>
</html>







