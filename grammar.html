<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>基本語法（角括號標記版）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}
    .anchor{scroll-margin-top:80px}

    .control-card{background:#1b1f22}
    .control-row{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
    .control-row .group{display:flex;align-items:center;gap:.5rem}
    .control-row label,.control-row span,.control-row select{color:#fff}
    .range-inline{width:260px;min-width:200px}

    :root{--indent:1.25rem}
    .depth-0{padding-left:0}
    .depth-1{padding-left:calc(var(--indent)*1)}
    .depth-2{padding-left:calc(var(--indent)*2)}
    .line{padding:.18rem 0;border-left:1px solid rgba(255,255,255,.06)}
    .depth-0.line{border-left:none}
    .line.depth-1.item{padding-left:calc(var(--indent)*1.4)!important;padding-top:.12rem;padding-bottom:.12rem}

    .section{margin:2rem 0}
    .section-card{background:#1b1f22;border:1px solid rgba(255,255,255,.2);
      border-radius:.75rem; padding:.75rem .9rem;}
    .section-header{margin-bottom:.45rem}
    .section-title{color:#fff;font-weight:700;font-size:1rem}

    .say{cursor:pointer;display:inline-block;border-radius:.25rem;padding:0 .1rem;
         transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    .say:hover{background-color:rgba(255,255,255,.08)}
    .say:active{transform:scale(1.03)}
    .say.speaking{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    .muted{color:#adb5bd;font-size:.92em;cursor:default}

    /* 英中成對（基本為上下兩列） */
    .pair{margin:.32rem 0}
    .pair .en{display:block; margin:0}              /* 英文獨占一列 */
    .pair .zh{display:block; margin:-0.2rem 0 0}     /* 中文換行顯示 */
    /* .pair.tight{margin:.22rem 0}                    <+> 與上一列更緊 */
    .pair + .pair{margin-top:.24rem}

    /* 同一行寫成 <3>[EN] {ZH} 時：同列顯示 */
    .pair.inline{display:flex; align-items:baseline; gap:.5rem; flex-wrap:wrap}
    .pair.inline .en,.pair.inline .zh{display:inline; margin:0}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark sticky-top">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">基本語法</span>
      <div class="dropdown ms-auto">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
          章節選單
        </button>
        <ul id="chapterMenu" class="dropdown-menu dropdown-menu-end">
          <li><h6 class="dropdown-header">尚未載入</h6></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <div class="card control-card border-secondary mb-3">
      <div class="card-body">
        <div class="control-row">
          <div class="group">
            <label for="selEn" class="form-label mb-0">英文發音</label>
            <select id="selEn" class="form-select form-select-sm w-auto bg-dark text-light border-secondary"></select>
          </div>
          <div class="group">
            <label for="rate" class="form-label mb-0">語速：<span id="rateVal">1.00</span></label>
            <input id="rate" type="range" class="form-range range-inline" min="0.50" max="1.80" step="0.01" value="1.00">
          </div>
        </div>
      </div>
    </div>
    <div id="content"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== 返回鍵 =====
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ===== 語音設定（可儲存） =====
    const selEn=document.getElementById('selEn');
    const rateEl=document.getElementById('rate');
    const rateVal=document.getElementById('rateVal');
    let voices=[];
    const LS={voice:'tts.enVoice',rate:'tts.rate'};

    function loadVoices(){
      voices=speechSynthesis.getVoices();
      const list=voices.filter(v=>v.lang&&v.lang.toLowerCase().startsWith('en'))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const saved=localStorage.getItem(LS.voice);
      selEn.innerHTML='';
      list.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if(saved&&[...selEn.options].some(o=>o.value===saved)) selEn.value=saved;
      else if(list.length) selEn.value=list[0].value;
    }
    function getVoice(val){if(!val)return null;const [n,l]=val.split('||');return voices.find(v=>v.name===n&&v.lang===l)||voices.find(v=>v.lang===l)||null;}
    function speakEn(t){if(!t)return;const u=new SpeechSynthesisUtterance(t);const v=getVoice(selEn.value);if(v)u.voice=v;u.lang=v?.lang||'en-US';u.rate=parseFloat(rateEl.value)||1;u.pitch=1;u.volume=1;speechSynthesis.cancel();speechSynthesis.speak(u);}
    selEn.addEventListener('change',()=>localStorage.setItem(LS.voice,selEn.value));
    const savedRate=parseFloat(localStorage.getItem(LS.rate)||'1');rateEl.value=(isNaN(savedRate)?1:savedRate).toFixed(2);
    rateVal.textContent=parseFloat(rateEl.value).toFixed(2);
    rateEl.addEventListener('input',()=>{const r=parseFloat(rateEl.value)||1;rateVal.textContent=r.toFixed(2);localStorage.setItem(LS.rate,r.toFixed(2));});
    loadVoices();if('onvoiceschanged' in speechSynthesis)speechSynthesis.onvoiceschanged=loadVoices;

    // ===== 內容處理 =====
    const CONTENT_URL='content/grammar.txt';
    const contentEl=document.getElementById('content');
    const chapterMenu=document.getElementById('chapterMenu');
    const esc=s=>(s??'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

    function splitByBraces(s){
      const out=[];let last=0,m;const re=/\{[^}]*\}/g;
      while((m=re.exec(s))!==null){
        if(m.index>last) out.push({type:'text',value:s.slice(last,m.index)});
        out.push({type:'brace',value:m[0].slice(1,-1)});
        last=m.index+m[0].length;
      }
      if(last<s.length) out.push({type:'text',value:s.slice(last)});
      return out;
    }

    /* 一般行：先抽離 {} 再處理 [] 與 #URL#，最後把 {} 還原成灰字（{} 內絕不發音） */
    function renderInlineTokens(rawText){
      const src=rawText??'';
      const braceStore=[];
      let staged=src.replace(/\{[^}]*\}/g,m=>{
        const i=braceStore.push(m.slice(1,-1))-1;
        return `\uE000${i}\uE001`;
      });

      // 跳脫
      staged=esc(staged);

      // [] → 可點發音
      staged=staged.replace(/\[([^\]]+)\]/g,(m,p1)=>{
        const safe=esc(p1);
        return `<span class="say" tabindex="0" data-say="${safe}">${safe}</span>`;
      });

      // #URL# → [參考連結]（新分頁開啟，不改 history）
      staged=staged.replace(/#(https?:\/\/[^\s#]+)#/g,(m,url)=>{
        const safe=esc(url);
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer">[參考連結]</a>`;
      });

      // 還原 {} → 灰字、不發音（同時支援 {} 內 #URL#）
      staged=staged.replace(/\uE000(\d+)\uE001/g,(m,k)=>{
        const inner=braceStore[Number(k)]??'';
        const innerEsc=esc(inner).replace(/#(https?:\/\/[^\s#]+)#/g,(m2,u)=>`<a href="${esc(u)}" target="_blank" rel="noopener noreferrer">[參考連結]</a>`);
        return `<span class="muted">${innerEsc}</span>`;
      });

      return staged;
    }

    async function loadContent(){
      try{
        const res=await fetch(CONTENT_URL+'?c='+Date.now(),{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt=await res.text();
        render(txt);
      }catch(e){
        console.warn('讀取失敗',e);
      }
    }

    function render(text){
      contentEl.innerHTML='';
      chapterMenu.innerHTML='<li><h6 class="dropdown-header">章節</h6></li>';
      const lines=text.replace(/\r\n/g,'\n').split('\n');
      const startIdx=lines.findIndex(l=>/^\s*\[內容\]\s*$/.test(l));
      const work=(startIdx===-1?[]:lines.slice(startIdx+1)).map(s=>s.replace(/\s+$/,'')).filter(s=>s);
      let currentSectionBody=null,lastPairDiv=null;const chapters=[];

      for(let i=0;i<work.length;i++){
        const m=work[i].match(/^\s*<([123+])>\s*(.*)$/); if(!m) continue;
        const tag=m[1], textLine=m[2];

        if(tag==='1'){ // 章節（支援 #URL#）
          const rawTitle=textLine.replace(/\s*:\s*$/,'');
          const titleHTML=esc(rawTitle).replace(/#(https?:\/\/[^\s#]+)#/g,(mm,url)=>`<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">[參考連結]</a>`);
          const plainTitle=rawTitle.replace(/#https?:\/\/[^\s#]+#/g,'').trim();
          const id='sec-'+plainTitle.replace(/\s+/g,'-').replace(/[^\w\-一-龥]/g,'').toLowerCase()+'-'+i;

          const section=document.createElement('section');
          section.className='section anchor'; section.id=id;
          const card=document.createElement('div'); card.className='section-card';
          const header=document.createElement('div'); header.className='section-header';
          header.innerHTML=`<span class="section-title">${titleHTML}</span>`;
          card.appendChild(header);
          const body=document.createElement('div'); card.appendChild(body);
          section.appendChild(card); contentEl.appendChild(section);
          currentSectionBody=body; lastPairDiv=null;

          chapters.push({id,title:plainTitle});
          const li=document.createElement('li');
          li.innerHTML=`<a class="dropdown-item" href="#${id}">${esc(plainTitle)}</a>`;
          chapterMenu.appendChild(li);
          continue;
        }

        const parent=currentSectionBody||contentEl;

        if(tag==='2'){ // 項目
          const div=document.createElement('div');
          div.className='line depth-1 item';
          div.innerHTML=renderInlineTokens(textLine);
          parent.appendChild(div);
          lastPairDiv=null;
          continue;
        }

        if(tag==='3'){ // 英文範例：支援前置符號 + [EN] + 尾巴 {ZH}
          // 允許前置符號（不發音），如： "■[at the bus stop] {在公車站}"
          const m3=textLine.match(/^\s*([^\[]*)\[([^\]]+)\]\s*(.*)$/);
          const prefix = m3 ? m3[1] : '';                                   // 例： "■"
          const enCore = m3 ? m3[2] : textLine.replace(/^\s*\[|\]\s*$/g,''); // 例： "at the bus stop"
          const tail   = m3 ? m3[3] : '';                                    // 例： " {在公車站}"
          const sayText=enCore.replace(/\{[^}]*\}/g,'').replace(/\s+/g,' ').trim();

          const pair=document.createElement('div');
          pair.className='pair depth-2' + (tail.trim()? ' inline':'');

          const en=document.createElement('span');
          en.className='en';

          // 前置符號：原樣保留，不發音
          if(prefix){
            const pre=document.createElement('span');
            pre.textContent=prefix; // 不加 .say
            en.appendChild(pre);
          }

          // 主體英文：將 {} 變灰字；其餘文本可點發音（朗讀整句 sayText）
          splitByBraces(enCore).forEach(tok=>{
            if(tok.type==='text' && tok.value){
              const span=document.createElement('span');
              span.className='say';
              span.tabIndex=0;
              span.setAttribute('data-say',sayText);
              span.textContent=tok.value;
              en.appendChild(span);
            }else if(tok.type==='brace'){
              const mm=document.createElement('span');
              mm.className='muted';
              // {} 內若含 #URL# → [參考連結]
              const inner=tok.value.replace(/#(https?:\/\/[^\s#]+)#/g,(m2,u)=>`<a href="${esc(u)}" target="_blank" rel="noopener noreferrer">[參考連結]</a>`);
              mm.innerHTML=inner;
              en.appendChild(mm);
            }
          });

          pair.appendChild(en);

          // 同列尾巴（通常是 {中文}），顯示在右側（灰字）
          if(tail && tail.trim()){
            const zhInline=document.createElement('span');
            zhInline.className='zh muted';
            zhInline.innerHTML=renderInlineTokens(tail);
            pair.appendChild(zhInline);
          }

          parent.appendChild(pair);
          lastPairDiv=pair;
          continue;
        }

        if(tag==='+'){ // 中文譯文：另起一列、間距更緊
          if(lastPairDiv){
            lastPairDiv.classList.add('tight');
            const zh=document.createElement('span');
            zh.className='zh muted';
            zh.innerHTML=renderInlineTokens(textLine);
            lastPairDiv.appendChild(zh);
          }else{
            const alone=document.createElement('div');
            alone.className='pair depth-2 tight';
            alone.innerHTML=`<span class="zh muted">${renderInlineTokens(textLine)}</span>`;
            parent.appendChild(alone);
            lastPairDiv=alone;
          }
          continue;
        }
      }

      // 章節選單平滑卷動（不改網址）
      chapterMenu.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          const id=a.getAttribute('href').slice(1);
          const t=document.getElementById(id);
          if(t) t.scrollIntoView({behavior:'smooth',block:'start'});
        });
      });

      // 朗讀事件（只綁 .say）
      contentEl.querySelectorAll('.say').forEach(el=>{
        el.addEventListener('click',()=>{
          el.classList.add('speaking');
          const t=el.getAttribute('data-say')||el.textContent.trim();
          speakEn(t);
          setTimeout(()=>el.classList.remove('speaking'),300);
        });
        el.addEventListener('keydown',e=>{
          if(e.key==='Enter'||e.key===' '){e.preventDefault();el.click();}
        });
      });

      // 灰字阻止冒泡，避免觸發父層朗讀
      contentEl.querySelectorAll('.muted').forEach(el=>{
        el.addEventListener('click',e=>e.stopPropagation());
        el.addEventListener('mousedown',e=>e.stopPropagation());
        el.addEventListener('touchstart',e=>e.stopPropagation());
      });

      if(!chapters.length){
        chapterMenu.innerHTML='<li><h6 class="dropdown-header">沒有章節</h6></li>';
      }
    }

    loadContent();
  </script>
</body>
</html>












