<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¤‡ç¿’å–®å­—</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#212529;color:#f8f9fa}
    .container-narrow{max-width:980px}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}
    tr.group-start td{border-top-width:2px !important}

    /* å…©æ¬„è¡¨æ ¼ï¼ˆç„¡è¡¨é ­ï¼‰ */
    .table{table-layout:fixed}
    .idx-cell{width:72px;cursor:pointer;user-select:none}

    /* æ¬¡è¦æ–‡å­— */
    .small-muted{color:#adb5bd;font-size:.9rem}

    /* å¯ç™¼éŸ³æ•ˆæœï¼ˆè‹±èªï¼‰ */
    [data-say]{cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    [data-say]:hover{background-color:rgba(255,255,255,.06)}
    [data-say]:active{transform:scale(1.03)}
    @media (prefers-reduced-motion: reduce){[data-say]{transition:none}}
    .speaking{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    /* å·¦æ¬„ç´¢å¼•ï¼‹â˜… */
    .idx-wrap{display:flex;flex-direction:column;align-items:center;gap:.25rem}
    .idx-star{font-size:18px;line-height:1;color:#ff9800 !important}

    /* æ–‡å­—æ’ç‰ˆ */
    .word-line b{font-size:1.05rem}
    .kk{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;margin:0 .5rem;opacity:.95}

    .input-group .form-control.is-invalid{border-color:#dc3545}

    /* ===== é ‚éƒ¨æ§åˆ¶åˆ—ï¼šèªéŸ³ / èªé€Ÿ / æ¨¡å¼ åŒä¸€åˆ—ï¼Œå„ä½” 1/3 ===== */
    .ctl-row{
      display:flex; gap:.75rem; align-items:stretch; flex-wrap:nowrap;
      overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin;
    }
    .ctl-third{
      flex:1 1 33.333%;
      min-width:260px;
    }
    .ctl-card{
      background:#171a1d; border:1px solid rgba(255,255,255,.12);
      border-radius:.75rem; padding:.6rem .75rem; white-space:nowrap;
      height:100%;
    }
    .ctl-inline{display:flex; align-items:center; gap:.5rem; white-space:nowrap}
    .ctl-inline label{margin:0; color:#f8f9fa}

    /* å¾®ç¸®å°ºå¯¸ */
    .ctl-inline select#selEn.form-select{ width:100%; min-width:140px; padding-top:.15rem; padding-bottom:.15rem; }
    .range-inline{ width:100%; min-width:120px }
    .mode-btns{flex-wrap:nowrap}
    .mode-btns .btn{min-width:4.0rem; padding:.2rem .5rem; line-height:1.1}

    /* è©³ç´°æ¨¡å¼ä¸­çš„ä¾‹å¥è¡Œè·å°äº› */
    .ex-line{line-height:1.35}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container container-narrow d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">è¿”å›</button>
      <span class="navbar-brand ms-3 mb-0 h1">è¤‡ç¿’å–®å­—</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="badge text-bg-warning" id="starCount">â˜… 0</span>
        <button id="clearStarsBtn" class="btn btn-outline-warning btn-sm">æ¸…é™¤æ¨™è¨»</button>
      </div>
    </div>
  </nav>

  <main class="container container-narrow my-3">
    <!-- âœ… èªéŸ³ / èªé€Ÿ / æ¨¡å¼ï¼šåŒä¸€åˆ—ï¼Œå„ä½” 1/3 -->
    <div class="ctl-row mb-3">
      <!-- èªéŸ³ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label for="selEn">èªéŸ³</label>
            <select id="selEn" class="form-select form-select-sm bg-dark text-light border-secondary"></select>
          </div>
        </div>
      </div>
      <!-- èªé€Ÿ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label for="rate">èªé€Ÿ</label>
            <span id="rateVal">1.00</span>
            <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00">
          </div>
        </div>
      </div>
      <!-- æ¨¡å¼ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label>æ¨¡å¼</label>
            <div class="btn-group mode-btns" role="group" aria-label="modes">
              <button class="btn btn-primary btn-sm" data-mode="normal">æ­£å¸¸</button>
              <button class="btn btn-outline-light btn-sm" data-mode="zh">ä¸­æ–‡</button>
              <button class="btn btn-outline-light btn-sm" data-mode="en">è‹±æ–‡</button>
              <button class="btn btn-outline-light btn-sm" data-mode="voice">èªéŸ³</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ†é ï¼ˆä¸Šæ–¹ï¼‰ -->
    <nav class="mb-2 d-flex justify-content-center align-items-center gap-2 flex-wrap">
      <ul id="pagination" class="pagination mb-0"></ul>
      <div class="input-group input-group-sm" style="width:170px">
        <input id="pageJump" type="number" class="form-control bg-dark text-light border-secondary" min="1" placeholder="é ç¢¼">
        <button id="pageGo" class="btn btn-outline-light">Go</button>
      </div>
    </nav>

    <!-- å…©æ¬„è¡¨æ ¼ -->
    <div class="table-responsive">
      <table id="voca" class="table table-dark table-hover align-middle mb-3">
        <tbody></tbody>
      </table>
    </div>

    <!-- ä¸‹æ–¹å¿«é€Ÿä¸Šä¸‹é  -->
    <nav class="mt-2">
      <div id="quickPager" class="d-flex justify-content-center align-items-center gap-2 flex-wrap"></div>
    </nav>

    <!-- ç©ºç‹€æ…‹ -->
    <div id="emptyState" class="text-center text-secondary my-4" style="display:none">
      ç›®å‰æ²’æœ‰å·²æ¨™è¨»çš„å–®å­—ã€‚åˆ°ã€Œå…¨éƒ¨å–®å­—ã€é é¢å…ˆåŠ äº›â˜…å§ï¼
    </div>
  </main>

  <script>
    const EN_LANG = 'en-US';
    const pageSize = 10;

    const $tbody  = document.querySelector('#voca tbody');
    const $pagination = document.getElementById('pagination');
    const $selEn = document.getElementById('selEn');
    const $rate = document.getElementById('rate');
    const $rateVal = document.getElementById('rateVal');
    const $empty = document.getElementById('emptyState');
    const $starCount = document.getElementById('starCount');
    const $modeBtns = document.querySelector('.mode-btns');

    // æ¨¡å¼ï¼ˆä¸å„²å­˜ï¼Œé è¨­ normalï¼‰
    const Modes = { NORMAL:'normal', ZH:'zh', EN:'en', VOICE:'voice' };
    let currentMode = Modes.NORMAL;
    // è¨˜éŒ„å“ªäº› idx æ­£åœ¨ã€Œè©³ç´°ã€ç‹€æ…‹
    const detailRows = new Set();

    let voices = [];
    let rows = [];       // æ‰€æœ‰å–®å­—ï¼ˆå¾ voca.txt è®€å…¥ï¼‰
    let rowsStar = [];   // åªé¡¯ç¤ºå·²æ¨™è¨»çš„
    let rate = parseFloat(localStorage.getItem('tts.rate') || '1') || 1;
    let currentPage = parseInt(localStorage.getItem('voca.review.currentPage') || '1', 10) || 1;

    /* ====== è§£æ voca.txtï¼š7 æ¬„ ====== */
    function parseTSV(txt){
      return txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n')
        .map(l=>l.trim()).filter(l=>l && !l.startsWith('#'))
        .map(line=>{
          const p=line.split('\t');
          const [idx,word,kk,zh,pos,exEn,exZh] = [
            p[0]||'', p[1]||'', p[2]||'',
            p[3]||'', p[4]||'', p[5]||'', p[6]||''
          ];
          return { idx, word, kk, zh, pos, exEn, exZh };
        });
    }

    /* ====== èªéŸ³ï¼ˆé¸æ“‡æ¸…å–®ï¼‰ ====== */
    function loadVoices(){ voices = speechSynthesis.getVoices(); populateEnVoices(); }
    function populateEnVoices(){
      if (!voices.length) return;
      const enList = voices
        .filter(v => v.lang?.toLowerCase().startsWith('en'))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      fillSelect($selEn, enList, localStorage.getItem('tts.enVoice'));
      if (!$selEn.value && enList.length) $selEn.value = enList[0].name+'||'+enList[0].lang;
    }
    function fillSelect(sel, list, saved){
      sel.innerHTML = '';
      for(const v of list){
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' â˜…':''}`;
        sel.appendChild(opt);
      }
      if (saved && [...sel.options].some(o=>o.value===saved)) sel.value=saved;
    }
    loadVoices();
    if('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged=loadVoices;

    function getVoiceByValue(val){
      if(!val) return null;
      const [name,lang]=val.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) ||
             voices.find(v=>v.lang===lang) ||
             voices.find(v=>v.name===name) || null;
    }
    function speakEn(text, ondone){
      if(!text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang=EN_LANG;
      const chosen=getVoiceByValue($selEn.value);
      if(chosen) u.voice=chosen;
      u.rate=rate; u.pitch=1; u.volume=1;
      u.onend=()=>ondone&&ondone();
      u.onerror=()=>ondone&&ondone();
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    /* ====== æ¨™è¨»å­˜å– ====== */
    function loadStars(){
      try{
        const arr = JSON.parse(localStorage.getItem('voca.stars') || '[]');
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveStars(list){
      const nums=[], strs=[];
      for(const v of list){ const n=Number(v); if(!Number.isNaN(n)) nums.push(n); else strs.push(String(v)); }
      nums.sort((a,b)=>a-b); strs.sort();
      const merged=[...nums.map(n=>String(n)), ...strs];
      localStorage.setItem('voca.stars', JSON.stringify(merged));
      return merged;
    }
    function getStarsSet(){ return new Set(loadStars()); }
    function isStarred(idx){ return getStarsSet().has(String(idx)); }
    function updateStarCount(){ $starCount.textContent = `â˜… ${loadStars().length}`; }

    /* ====== ä»¥æ˜Ÿè™Ÿå»ºç«‹ rowsStar ====== */
    function buildInitialStarRows(){
      const set = getStarsSet();
      rowsStar = rows.filter(r => set.has(String(r.idx)));
      const nums=[],strs=[];
      for(const r of rowsStar){ const n=Number(r.idx); if(!Number.isNaN(n)) nums.push(r); else strs.push(r); }
      nums.sort((a,b)=>Number(a.idx)-Number(b.idx));
      strs.sort((a,b)=>String(a.idx).localeCompare(String(b.idx)));
      rowsStar = [...nums, ...strs];
    }
    function purgeUnstarredFromRowsStar(){
      const set = getStarsSet();
      rowsStar = rowsStar.filter(r => set.has(String(r.idx)));
    }

    function savePage(){ localStorage.setItem('voca.review.currentPage', String(currentPage)); }
    function goPage(p){
      const totalPages = Math.ceil(rowsStar.length / pageSize) || 1;
      const nextPage = Math.min(Math.max(1, p), totalPages || 1);
      if (nextPage !== currentPage){
        purgeUnstarredFromRowsStar();
        detailRows.clear(); // æ›é æ™‚é›¢é–‹æ‰€æœ‰è©³ç´°
      }
      currentPage = Math.min(Math.max(1, nextPage), Math.ceil(rowsStar.length / pageSize) || 1);
      savePage();
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ====== æ¨¡å¼æŒ‰éˆ• ====== */
    $modeBtns.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;
      currentMode = btn.dataset.mode; // ä¸å­˜ï¼Œé è¨­ normal
      [...$modeBtns.querySelectorAll('button')].forEach(b=>{
        if (b===btn){ b.classList.remove('btn-outline-light'); b.classList.add('btn-primary'); }
        else { b.classList.add('btn-outline-light'); b.classList.remove('btn-primary'); }
      });
      detailRows.clear(); // åˆ‡æ¨¡å¼æ™‚é›¢é–‹æ‰€æœ‰è©³ç´°
      render();
    });

    /* ====== æ¸²æŸ“ï¼šä¾æ¨¡å¼ç”Ÿæˆåˆ— ====== */
    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    function makeIdxCell(idx, starSet, rowSpan=1){
      const tdIdx=document.createElement('td');
      tdIdx.rowSpan=rowSpan;
      tdIdx.className='text-secondary small text-center align-middle idx-cell';
      tdIdx.dataset.idx = idx;

      const idxWrap=document.createElement('div');
      idxWrap.className='idx-wrap';
      const idxText=document.createElement('div'); idxText.textContent=idx;
      const starSpan=document.createElement('div'); starSpan.className='idx-star'; starSpan.textContent='â˜…';
      starSpan.hidden = !starSet.has(String(idx));
      idxWrap.append(idxText,starSpan);
      tdIdx.appendChild(idxWrap);
      return tdIdx;
    }
    function makeToggleBtn(onClick){
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='btn btn-outline-light btn-sm';
      btn.textContent='åˆ‡æ›';
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); onClick(); });
      return btn;
    }

    function render(){
      $tbody.innerHTML='';
      const totalPages = Math.ceil(rowsStar.length / pageSize) || 1;
      if (currentPage > totalPages) currentPage = totalPages || 1;

      // ç©ºç‹€æ…‹
      if (rowsStar.length === 0){
        document.querySelector('table#voca').style.display='none';
        document.getElementById('quickPager').innerHTML='';
        $pagination.innerHTML='';
        $empty.style.display='';
        updateStarCount();
        return;
      } else {
        document.querySelector('table#voca').style.display='';
        $empty.style.display='none';
      }

      const start=(currentPage-1)*pageSize;
      const pageRows=rowsStar.slice(start,start+pageSize);
      const starSet = getStarsSet();

      for(const r of pageRows){
        const idx = escapeHTML(r.idx);
        const word= escapeHTML(r.word);
        const kk  = escapeHTML(r.kk);
        const zh  = escapeHTML(r.zh);
        const pos = escapeHTML(r.pos);
        const exEn= escapeHTML(r.exEn);
        const exZh= escapeHTML(r.exZh);

        const inDetail = detailRows.has(String(r.idx));

        /* ===== è©³ç´°ï¼ˆ= æ­£å¸¸ + å³å´æœ‰åˆ‡æ›éˆ•ï¼Œ3 è¡Œï¼‰ ===== */
        if (inDetail){
          const tr1=document.createElement('tr');
          tr1.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 3);

          const tdMain=document.createElement('td');
          tdMain.className='word-line';
          tdMain.setAttribute('data-say', r.word);
          tdMain.setAttribute('data-lang','en');

          const row = document.createElement('div');
          row.className='d-flex justify-content-between align-items-center gap-2';
          const left = document.createElement('div');
          left.innerHTML = `<b>${word}</b> <span class="kk small-muted">${kk}</span> <span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          const btn = makeToggleBtn(()=>{
            detailRows.delete(String(r.idx));
            render(); // å›åˆ°ä¸Šå€‹æ¨¡å¼ï¼ˆç”± currentMode æ§åˆ¶ï¼‰
          });
          row.append(left, btn);
          tdMain.appendChild(row);

          tr1.append(tdIdx, tdMain);

          const tr2=document.createElement('tr');
          const tdExEn=document.createElement('td');
          tdExEn.className='ex-line';
          tdExEn.innerHTML = `<span class="small-muted">${exEn || ''}</span>`;
          if (r.exEn){
            tdExEn.setAttribute('data-say', r.exEn);
            tdExEn.setAttribute('data-lang','en');
          }
          tr2.append(tdExEn);

          const tr3=document.createElement('tr');
          const tdExZh=document.createElement('td');
          tdExZh.className='ex-line';
          tdExZh.innerHTML = `<span class="small-muted">${exZh || ''}</span>`;
          tr3.append(tdExZh);

          $tbody.append(tr1, tr2, tr3);
          continue;
        }

        /* ===== æ­£å¸¸ï¼ˆ3 è¡Œï¼Œç„¡åˆ‡æ›éˆ•ï¼‰ ===== */
        if (currentMode === Modes.NORMAL){
          const tr1=document.createElement('tr');
          tr1.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 3);
          const tdMain=document.createElement('td');
          tdMain.className='word-line';
          tdMain.setAttribute('data-say', r.word);
          tdMain.setAttribute('data-lang','en');
          tdMain.innerHTML = `<b>${word}</b> <span class="kk small-muted">${kk}</span> <span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          tr1.append(tdIdx, tdMain);

          const tr2=document.createElement('tr');
          const tdExEn=document.createElement('td');
          tdExEn.className='ex-line';
          tdExEn.innerHTML = `<span class="small-muted">${exEn || ''}</span>`;
          if (r.exEn){
            tdExEn.setAttribute('data-say', r.exEn);
            tdExEn.setAttribute('data-lang','en');
          }
          tr2.append(tdExEn);

          const tr3=document.createElement('tr');
          const tdExZh=document.createElement('td');
          tdExZh.className='ex-line';
          tdExZh.innerHTML = `<span class="small-muted">${exZh || ''}</span>`;
          tr3.append(tdExZh);

          $tbody.append(tr1, tr2, tr3);
          continue;
        }

        /* ===== ä¸­æ–‡ï¼ˆ1 è¡Œï¼šä¸­æ–‡ + è©æ€§ + å³å´åˆ‡æ›ï¼‰ ===== */
        if (currentMode === Modes.ZH){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);
          const td=document.createElement('td');

          const row = document.createElement('div');
          row.className='d-flex justify-content-between align-items-center gap-2';
          const left = document.createElement('div');
          left.innerHTML = `<span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });
          row.append(left, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }

        /* ===== è‹±æ–‡ï¼ˆ1 è¡Œï¼šè‹±æ–‡ + å³å´åˆ‡æ›ï¼‰ ===== */
        if (currentMode === Modes.EN){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);
          const td=document.createElement('td');

          const row = document.createElement('div');
          row.className='d-flex justify-content-between align-items-center gap-2';
          const left = document.createElement('div');
          left.setAttribute('data-say', r.word);
          left.setAttribute('data-lang','en');
          left.innerHTML = `<b>${word}</b>`;
          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });
          row.append(left, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }

        /* ===== èªéŸ³ï¼ˆ1 è¡Œï¼šé¡¯ç¤ºã€Œé»æ“Šç™¼éŸ³ã€ï¼‹å³å´åˆ‡æ›ï¼›å¯ç™¼éŸ³ï¼‰ ===== */
        if (currentMode === Modes.VOICE){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);

          const td=document.createElement('td');
          // è®“æ•´å€‹å„²å­˜æ ¼éƒ½å¯ä»¥é»æ“Šæœ—è®€ï¼ˆé™¤äº†åˆ‡æ›éˆ•æœƒ stopPropagationï¼‰
          td.setAttribute('data-say', r.word);
          td.setAttribute('data-lang','en');
          td.style.cursor = 'pointer';

          // åŒä¸€è¡Œæ©«æ’ï¼šå·¦ã€Œé»æ“Šç™¼éŸ³ã€ï¼Œå³ã€Œåˆ‡æ›ã€éˆ•
          const row = document.createElement('div');
          row.className='d-flex flex-row flex-nowrap align-items-center justify-content-between gap-2';

          const speakArea = document.createElement('div');
          speakArea.className = 'flex-grow-1 text-secondary';
          speakArea.style.minHeight = '1.25rem';
          speakArea.title = 'é»æ­¤ç™¼éŸ³';
          speakArea.textContent = 'ğŸ”Š é»æ“Šç™¼éŸ³';

          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });

          row.append(speakArea, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }
      }

      renderPagination(totalPages);
      renderQuickPager(totalPages);
      updateStarCount();
    }

    /* ====== åˆ†é /å¿«é€Ÿéµ ====== */
    function renderPagination(totalPages){
      $pagination.innerHTML='';
      const add=(label,page,disabled=false,active=false)=>{
        const li=document.createElement('li');
        li.className=`page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML=`<a class="page-link" href="#">${label}</a>`;
        if(!disabled) li.addEventListener('click',e=>{e.preventDefault();goPage(page);});
        $pagination.appendChild(li);
      };
      add('<<', Math.max(1, currentPage-1), currentPage===1);
      for(let i=1;i<=totalPages;i++) add(i, i, false, i===currentPage);
      add('>>', Math.min(totalPages, currentPage+1), currentPage===totalPages);

      // ç›´æ¥è¼¸å…¥è·³é 
      const pageJump = document.getElementById('pageJump');
      const pageGo = document.getElementById('pageGo');
      if (pageJump){
        pageJump.max = totalPages;
        const go = () => {
          const p = parseInt(pageJump.value, 10);
          if (!isNaN(p) && p >= 1 && p <= totalPages) goPage(p);
          else {
            pageJump.classList.add('is-invalid');
            setTimeout(()=>pageJump.classList.remove('is-invalid'), 1200);
          }
        };
        pageJump.onkeydown = (e)=>{ if(e.key==='Enter') go(); };
        if (pageGo) pageGo.onclick = go;
      }
    }

    function renderQuickPager(totalPages){
      const qp=document.getElementById('quickPager');
      qp.innerHTML='';
      if(totalPages<=1) return;

      const makeBtn=(label,handler,disabled=false,primary=false)=>{
        const btn=document.createElement('button');
        btn.className=`btn btn-sm ${primary?'btn-primary':'btn-outline-light'}`;
        btn.textContent=label; btn.disabled=!!disabled;
        if(handler) btn.addEventListener('click', handler);
        return btn;
      };

      if(currentPage<=1){
        qp.appendChild(makeBtn('1', null, true, true));
        qp.appendChild(makeBtn('>>', ()=>goPage(currentPage+1)));
      }else if(currentPage>=totalPages){
        qp.appendChild(makeBtn('<<', ()=>goPage(currentPage-1)));
        qp.appendChild(makeBtn(String(totalPages), null, true, true));
      }else{
        qp.appendChild(makeBtn('<<', ()=>goPage(currentPage-1)));
        qp.appendChild(makeBtn(String(currentPage), null, true, true));
        qp.appendChild(makeBtn('>>', ()=>goPage(currentPage+1)));
      }
    }

    /* ====== äº‹ä»¶ï¼šè¡¨æ ¼ã€æ˜Ÿè™Ÿã€è¿”å›ã€æ¸…é™¤ ====== */
    document.getElementById('voca').addEventListener('click', ev=>{
      // A) é»å·¦æ¬„ â†’ åˆ‡æ›æ¨™è¨»ï¼ˆâ˜…ï¼‰
      const idxCell = ev.target.closest('td.idx-cell');
      if (idxCell){
        const idx = idxCell.dataset.idx;
        const set = getStarsSet();
        if (set.has(idx)) set.delete(idx); else set.add(idx);
        saveStars([...set]);
        const star = idxCell.querySelector('.idx-star');
        if (star) star.hidden = !isStarred(idx);
        updateStarCount();
        ev.stopPropagation();
        return;
      }

      // B) ä»»ä½•æ¨¡å¼ï¼šè‹¥é»åˆ°å¸¶ data-say çš„è‹±æ–‡ â†’ ç™¼éŸ³
      const el = ev.target.closest('[data-say]');
      if(el){
        const isEn = (el.getAttribute('data-lang')||'').toLowerCase().startsWith('en');
        if (isEn){
          const text = el.getAttribute('data-say')||el.textContent||'';
          el.classList.add('speaking');
          speakEn(text, ()=>el.classList.remove('speaking'));
        }
      }
    });

    document.getElementById('backBtn').addEventListener('click', ()=>history.back());
    document.getElementById('clearStarsBtn').addEventListener('click', ()=>{
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨™è¨»å—ï¼Ÿ')) return;
      localStorage.setItem('voca.stars', '[]');
      rowsStar = [];
      currentPage = 1;
      detailRows.clear();
      render();
    });

    // èªéŸ³è¨­å®š
    $selEn.addEventListener('change', ()=>localStorage.setItem('tts.enVoice',$selEn.value));
    $rate.addEventListener('input', ()=>{
      rate = parseFloat($rate.value)||1;
      $rateVal.textContent = rate.toFixed(2);
      localStorage.setItem('tts.rate', rate);
    });

    /* ====== è¼‰å…¥è³‡æ–™ ====== */
    async function loadData(){
      try{
        const res = await fetch('content/voca.txt?c='+Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        rows = parseTSV(text);
        buildInitialStarRows();
        const totalPages = Math.ceil(rowsStar.length/pageSize) || 1;
        if (currentPage > totalPages) currentPage = totalPages || 1;
        if (currentPage < 1) currentPage = 1;
        render();
      }catch(err){
        alert('è®€å–å¤±æ•—ï¼š'+err.message);
      }
    }

    // åˆå§‹åŒ–
    $rate.value = rate.toFixed(2);
    $rateVal.textContent = rate.toFixed(2);
    updateStarCount();
    loadData();
  </script>
</body>
</html>


