<!DOCTYPE html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單字測驗</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}
    .card{background:#1b1f22;border:1px solid rgba(255,255,255,.12)}
    .q-item{background:#2a2f33;border:1px solid rgba(255,255,255,.12)}
    .q-item + .q-item{margin-top:.5rem}
    .answer-input{min-width:180px}
    .btn, .answer-input{transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:scale(1.03)}
    .answer-input:focus{box-shadow:0 0 0 .25rem rgba(var(--bs-primary-rgb), .25)}
    .badge-answer{background:#fff;color:#000}
    .is-correct{border-color:#3ddc97 !important}
    .is-wrong{border-color:#ff6b6b !important;color:#ff6b6b !important}
    .hint{color:#adb5bd}
    /* 讓整列可點焦點 */
    .list-item-focus{outline:none}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex justify-content-start">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">單字測驗</span>
    </div>
  </nav>

  <main class="container py-3">
    <!-- 控制列 -->
    <div class="card mb-3">
      <div class="card-body">
        <!-- 模式切換 -->
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
          <div class="btn-group btn-group-sm" role="group" aria-label="mode">
            <button id="modeNormal" class="btn btn-outline-light" data-mode="normal">一般</button>
            <button id="modeReview" class="btn btn-outline-light" data-mode="review">複習</button>
          </div>
          <div id="loadInfo" class="hint small ms-auto">資料載入中…</div>
        </div>

        <div class="row gy-3 gx-3 align-items-end">
          <!-- 起始值（一般模式用） -->
          <div class="col-12 col-md-4" id="colStart">
            <label class="form-label mb-1">起始編號</label>
            <div class="input-group input-group-sm">
              <button class="btn btn-outline-light" id="startMinus">−</button>
              <input id="startIdx" type="number" class="form-control text-center" min="1" value="1" step="1">
              <button class="btn btn-outline-light" id="startPlus">＋</button>
            </div>
          </div>

          <!-- 結束值（一般模式用） -->
          <div class="col-12 col-md-4" id="colEnd">
            <label class="form-label mb-1">結束編號</label>
            <div class="input-group input-group-sm">
              <button class="btn btn-outline-light" id="endMinus">−</button>
              <input id="endIdx" type="number" class="form-control text-center" min="1" value="25" step="1">
              <button class="btn btn-outline-light" id="endPlus">＋</button>
            </div>
          </div>

          <!-- 測驗字數（兩種模式都用，容量依模式決定） -->
          <div class="col-12 col-md-4" id="colCount">
            <label class="form-label mb-1">測驗字數 <span class="hint" id="capHint"></span></label>
            <div class="input-group input-group-sm">
              <button class="btn btn-outline-light" id="minusBtn">−</button>
              <input id="countInput" type="number" class="form-control text-center" min="0" value="25" step="1">
              <button class="btn btn-outline-light" id="plusBtn">＋</button>
            </div>
          </div>

          <!-- 操作 -->
          <div class="col-12 text-md-end">
            <div class="d-flex gap-2 justify-content-md-end">
              <button id="startBtn" class="btn btn-primary btn-sm">測驗</button>
              <button id="clearBtn" class="btn btn-outline-light btn-sm">清除</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 題目區 -->
    <div id="quizArea" class="mb-3"></div>

    <!-- 結果區 -->
    <div id="resultArea" class="alert alert-info d-none"></div>
  </main>

  <script>
    // ====== 快捷 ======
    const $ = s => document.querySelector(s);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const TYPING_INPUT_TYPES = new Set([
      'insertText','insertFromPaste','insertFromDrop','insertCompositionText',
      'deleteContentBackward','deleteContentForward','deleteByCut'
    ]);
    const isSpinnerLike = (e) => !e || !e.inputType || !TYPING_INPUT_TYPES.has(e.inputType);

    // ====== DOM ======
    const backBtn = $('#backBtn');

    const modeNormalBtn = $('#modeNormal');
    const modeReviewBtn = $('#modeReview');
    const capHint = $('#capHint');

    const colStart = $('#colStart');
    const colEnd   = $('#colEnd');

    const startIdxEl = $('#startIdx');
    const endIdxEl   = $('#endIdx');
    const startMinus = $('#startMinus');
    const startPlus  = $('#startPlus');
    const endMinus   = $('#endMinus');
    const endPlus    = $('#endPlus');

    const countInput = $('#countInput');
    const minusBtn   = $('#minusBtn');
    const plusBtn    = $('#plusBtn');

    const startBtn   = $('#startBtn');
    const clearBtn   = $('#clearBtn');

    const loadInfo   = $('#loadInfo');
    const quizArea   = $('#quizArea');
    const resultArea = $('#resultArea');

    backBtn.addEventListener('click', () => history.back());

    // ====== 狀態 ======
    let MODE = localStorage.getItem('exam.mode') || 'normal'; // 'normal' | 'review'
    let allRows = []; // {idx, idxNum, en, zh, pos, exEn, exZh}
    let MAX_IDX = 1;

    // ====== 資料 ======
    fetch('content/voca.txt?c=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(txt => {
        allRows = parseTSV(txt);
        const idxList = allRows.map(r => r.idxNum);
        const minIdx = Math.min(...idxList);
        MAX_IDX = Math.max(...idxList);

        // 一般模式預設起迄
        startIdxEl.value = isFinite(minIdx) ? minIdx : 1;
        endIdxEl.value   = isFinite(minIdx) ? Math.min(minIdx + 24, MAX_IDX) : 25;

        updateLoadInfo();
        applyModeUI(true); // 初始化 UI 與容量/字數
      })
      .catch(err => { loadInfo.textContent = '讀取失敗：' + err.message; });

    function parseTSV(txt){
      return txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n')
        .map(l=>l.trim()).filter(l=>l && !l.startsWith('#'))
        .map(line=>{
          const p = line.split('\t');
          const [idx,en,zh,pos,exEn,exZh] = [
            (p[0]||'').trim(),
            (p[1]||'').trim(),
            (p[2]||'').trim(),
            (p[3]||'').trim(),
            (p[4]||'').trim(),
            (p[5]||'').trim(),
          ];
          const idxNum = parseInt(idx,10);
          return { idx, idxNum: isNaN(idxNum)? -1: idxNum, en, zh, pos, exEn, exZh };
        })
        .filter(r => r.idxNum >= 1 && r.en);
    }

    // ====== 標註存取（複習模式來源） ======
    function loadStars(){
      try{
        const arr = JSON.parse(localStorage.getItem('voca.stars') || '[]');
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function getStarSet(){ return new Set(loadStars().map(String)); }
    function getStarRows(){
      const set = getStarSet();
      return allRows.filter(r => set.has(String(r.idx)));
    }

    // ====== 範圍/容量 ======
    function getLoHiRaw(){
      const s = parseInt(startIdxEl.value,10);
      const e = parseInt(endIdxEl.value,10);
      return [isNaN(s)?1:s, isNaN(e)?1:e];
    }
    function getLoHiOrdered(){
      const [s,e] = getLoHiRaw();
      return [Math.min(s,e), Math.max(s,e)];
    }
    function getRange(){ // 僅一般模式用的 R
      const [s,e] = getLoHiRaw();
      return (s>e) ? 0 : (e - s + 1);
    }
    function getCapacity(){ // 依模式決定可用上限
      if (MODE === 'review') return getStarRows().length;
      return getRange();
    }
    function setCountToCapacity(){ // 將字數設為當前容量
      const cap = getCapacity();
      countInput.value = Math.max(0, cap);
      setCapHint(cap);
    }
    function capCountToCapacity(){ // 將字數限制到容量內
      const cap = getCapacity();
      let v = parseInt(countInput.value,10);
      if (isNaN(v) || v < 0) v = 0;
      if (v > cap) v = cap;
      countInput.value = v;
      setCapHint(cap);
    }
    function setCapHint(cap){
      capHint.textContent = cap ? `（最多 ${cap}）` : '（目前無可用題目）';
      countInput.max = Math.max(0, cap);
    }

    // ====== 模式切換 UI ======
    function applyModeUI(isInit=false){
      // 切換按鈕外觀
      modeNormalBtn.classList.toggle('btn-primary', MODE==='normal');
      modeNormalBtn.classList.toggle('btn-outline-light', MODE!=='normal');
      modeReviewBtn.classList.toggle('btn-primary', MODE==='review');
      modeReviewBtn.classList.toggle('btn-outline-light', MODE!=='review');

      // 顯示/隱藏範圍欄位
      const showRange = (MODE === 'normal');
      colStart.classList.toggle('d-none', !showRange);
      colEnd.classList.toggle('d-none', !showRange);

      // 依模式設定「測驗字數」預設值
      if (MODE === 'review'){
        // 複習模式：預設 = 所有已標註數量
        setCountToCapacity();
      }else{
        // 一般模式：預設 = 目前的範圍長度
        setCountToCapacity();
      }

      // 更新載入資訊（顯示已標註數）
      updateLoadInfo();

      // 初始化時不用動；切換時清空目前題目
      if (!isInit){
        clearQuiz();
      }
    }

    modeNormalBtn.addEventListener('click', () => {
      if (MODE==='normal') return;
      MODE = 'normal';
      localStorage.setItem('exam.mode', MODE);
      applyModeUI();
    });
    modeReviewBtn.addEventListener('click', () => {
      if (MODE==='review') return;
      MODE = 'review';
      localStorage.setItem('exam.mode', MODE);
      applyModeUI();
    });

    // ====== 載入資訊 ======
    function updateLoadInfo(){
      const starN = getStarRows().length;
      loadInfo.textContent = `已載入 ${allRows.length} 筆（可用編號 1 ~ ${MAX_IDX}，已標註 ${starN}）`;
    }

    // ====== 起/迄輸入 ======
    startIdxEl.addEventListener('input', (e) => {
      if (MODE!=='normal') return; // 複習模式忽略
      let v = parseInt(startIdxEl.value,10);
      if (isNaN(v)) v = 1;
      v = clamp(v, 1, MAX_IDX);
      if (isSpinnerLike(e)) {
        const eVal = parseInt(endIdxEl.value,10) || 1;
        if (v > eVal) v = eVal;
      }
      startIdxEl.value = v;
      setCountToCapacity();
    });

    endIdxEl.addEventListener('input', (e) => {
      if (MODE!=='normal') return; // 複習模式忽略
      let v = parseInt(endIdxEl.value,10);
      if (isNaN(v)) v = 1;
      v = clamp(v, 1, MAX_IDX);
      if (isSpinnerLike(e)) {
        const sVal = parseInt(startIdxEl.value,10) || 1;
        if (v < sVal) v = sVal;
      }
      endIdxEl.value = v;
      setCountToCapacity();
    });

    // ====== 起/迄按鍵 ======
    startMinus.addEventListener('click', () => {
      if (MODE!=='normal') return;
      let s = clamp((parseInt(startIdxEl.value,10)||1) - 1, 1, MAX_IDX);
      const e = parseInt(endIdxEl.value,10)||1;
      if (s > e) s = e;
      startIdxEl.value = s;
      setCountToCapacity();
    });
    startPlus.addEventListener('click', () => {
      if (MODE!=='normal') return;
      let s = clamp((parseInt(startIdxEl.value,10)||1) + 1, 1, MAX_IDX);
      const e = parseInt(endIdxEl.value,10)||1;
      if (s > e) s = e;
      startIdxEl.value = s;
      setCountToCapacity();
    });

    endMinus.addEventListener('click', () => {
      if (MODE!=='normal') return;
      const s = parseInt(startIdxEl.value,10)||1;
      let e = clamp((parseInt(endIdxEl.value,10)||1) - 1, 1, MAX_IDX);
      if (e < s) e = s;
      endIdxEl.value = e;
      setCountToCapacity();
    });
    endPlus.addEventListener('click', () => {
      if (MODE!=='normal') return;
      const s = parseInt(startIdxEl.value,10)||1;
      let e = clamp((parseInt(endIdxEl.value,10)||1) + 1, 1, MAX_IDX);
      if (e < s) e = s;
      endIdxEl.value = e;
      setCountToCapacity();
    });

    // ====== 測驗字數：限制在 0~capacity ======
    function capCountHandler(){
      capCountToCapacity();
    }
    countInput.addEventListener('input', capCountHandler);
    minusBtn.addEventListener('click', () => {
      countInput.value = Math.max(0, (parseInt(countInput.value,10)||0) - 1);
      capCountToCapacity();
    });
    plusBtn.addEventListener('click', () => {
      countInput.value = Math.max(0, (parseInt(countInput.value,10)||0) + 1);
      capCountToCapacity();
    });
    countInput.addEventListener('keydown', e => {
      if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
      e.preventDefault();
      const dir = e.key === 'ArrowUp' ? +1 : -1;
      const cap = getCapacity();
      let v = parseInt(countInput.value,10); if (isNaN(v)) v = 0;
      v = clamp(v + dir, 0, cap);
      countInput.value = v;
    });

    // ====== 開始測驗 ======
    startBtn.addEventListener('click', () => {
      const cap = getCapacity();
      capCountToCapacity(); // 確保字數在上限內
      let want = parseInt(countInput.value,10) || 0;

      if (cap <= 0 || want <= 0){
        alert('目前沒有可用題目或測驗字數為 0，無法開始。');
        return;
      }

      let avail = [];
      if (MODE === 'review'){
        avail = getStarRows();
        if (!avail.length){ alert('目前沒有已標註的單字'); return; }
      }else{
        const [lo,hi] = getLoHiOrdered();
        avail = allRows.filter(r => r.idxNum >= lo && r.idxNum <= hi);
        if (!avail.length){ alert('此範圍沒有資料'); return; }
      }

      want = Math.min(want, cap, avail.length);
      const picked = randomSample(avail, want);
      renderQuiz(picked);
      resultArea.classList.add('d-none');
      resultArea.textContent = '';
    });

    clearBtn.addEventListener('click', clearQuiz);

    function clearQuiz(){
      quizArea.innerHTML = '';
      resultArea.classList.add('d-none');
      resultArea.textContent = '';
    }

    // ====== 工具 ======
    function randomSample(arr, n){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a.slice(0,n);
    }

    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c]));}
    function normalize(s){ return (s||'').trim().toLowerCase(); }
    function matchAnswer(user, ans){
      if (!user) return false;
      const cand = ans.split(/[\/,;、，；]\s*/).map(x=>normalize(x)).filter(Boolean);
      return cand.includes(user);
    }

    // ====== 題目渲染 & 驗證 ======
    function renderQuiz(rows){
      quizArea.innerHTML = '';
      let answered = 0, correct = 0;
      const total = rows.length;

      rows.forEach((r, idx) => {
        const item = document.createElement('div');
        item.className = 'q-item rounded p-3 list-item-focus';
        item.tabIndex = 0;

        const label = document.createElement('div');
        label.innerHTML = `
          <span class="text-secondary small">#${r.idx}</span>
          <b class="ms-2">${escapeHTML(r.zh)}</b>
          ${r.pos ? `<span class="ms-1 hint">（${escapeHTML(r.pos)}）</span>` : '' }
        `;

        const inputGrp = document.createElement('div');
        inputGrp.className = 'd-flex align-items-center gap-2 mt-2';
        inputGrp.innerHTML = `
          <input type="text" class="form-control form-control-sm answer-input" placeholder="輸入英文">
          <button class="btn btn-outline-light btn-sm confirm-btn">確認</button>
          <span class="ms-1 small result-flag"></span>
        `;

        const feedback = document.createElement('div');
        feedback.className = 'mt-2 small';

        item.append(label, inputGrp, feedback);
        quizArea.appendChild(item);

        const input = item.querySelector('.answer-input');
        const btn = item.querySelector('.confirm-btn');
        const flag = item.querySelector('.result-flag');

        input.addEventListener('keydown', e => { if(e.key==='Enter') btn.click(); });

        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const user = normalize(input.value);
          const ans = normalize(r.en);

          const ok = matchAnswer(user, ans);
          btn.disabled = true;
          input.disabled = true;

          if (ok){
            input.classList.add('is-correct');
            flag.innerHTML = `<span class="badge bg-success">正確</span>`;
            correct++;
          }else{
            input.classList.add('is-wrong');
            flag.innerHTML = `<span class="badge bg-danger">錯誤</span>`;
            feedback.innerHTML = `正確：<span class="badge badge-answer">${escapeHTML(r.en)}</span>`;
          }

          answered++;
          if (answered === total){
            const pct = ((correct/total)*100).toFixed(1);
            resultArea.className = 'alert alert-info';
            resultArea.classList.remove('d-none');
            resultArea.textContent = `結果：${correct} / ${total}（正確率 ${pct}%）`;
            resultArea.scrollIntoView({behavior:'smooth', block:'center'});
          }else{
            const next = item.nextElementSibling?.querySelector('.answer-input');
            if (next && !next.disabled) next.focus();
          }
        });

        if (idx === 0) setTimeout(()=>input.focus(), 0);
      });
    }

    // 初始化：套用記憶的模式按鈕樣式（資料載入後會再 applyModeUI(true)）
    (function primeModeButtons(){
      modeNormalBtn.classList.toggle('btn-primary', MODE==='normal');
      modeNormalBtn.classList.toggle('btn-outline-light', MODE!=='normal');
      modeReviewBtn.classList.toggle('btn-primary', MODE==='review');
      modeReviewBtn.classList.toggle('btn-outline-light', MODE!=='review');
    })();
  </script>
</body>
</html>







