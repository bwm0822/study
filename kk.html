<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KK 音標｜MP3 分段播放（暗色版）</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    body {background:#212529; color:#f8f9fa;}
    .tile {
      min-height:60px;
      font-size:24px;
      font-weight:700;
      padding:.5rem;
      transition: transform 0.1s ease, background-color 0.2s ease;
    }
    .tile.playing {
      outline:2px solid var(--bs-primary);
      box-shadow:0 0 0 .25rem rgba(var(--bs-primary-rgb),.25) inset;
    }
    .tile.btn:hover {
      background-color: rgba(255,255,255,.15);
    }
    .tile.btn:active {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <button class="btn btn-outline-light" onclick="history.back()">← 返回</button>
      <span id="status" class="badge text-bg-secondary">尚未載入</span>
    </div>
    <h1 class="h4 mb-2">KK 音標｜MP3 分段播放</h1>
    <p class="text-secondary">暗底、<strong>母音</strong>與<strong>子音</strong>分區。點符號播放對應 MP3 片段。</p>

    <div id="error" class="alert alert-danger d-none" role="alert"></div>

    <div class="row g-3">
      <div class="col-12">
        <h2 class="h6 mb-2">母音 Vowels（17）</h2>
        <div id="gridV" class="row g-2" aria-live="polite"></div>
      </div>
      <div class="col-12">
        <h2 class="h6 mb-2">子音 Consonants（24）</h2>
        <div id="gridC" class="row g-2" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
  const DEFAULT_URL = 'audio/kk.mp3';
  const VOWELS = ['i','ɪ','e','ɛ','æ','ɑ','ɔ','o','u','ʊ','ʌ','ə','ɚ','ɝ','aɪ','aʊ','ɔɪ'];
  const CONSONANTS = ['p','b','t','d','k','g','f','v','θ','ð','s','z','ʃ','ʒ','tʃ','dʒ','h','m','n','ŋ','l','r','w','j'];
  const SEGMENTS = {
    'i':{start:60+47.00,dur:0.5},
    'ɪ':{start:60+51.00,dur:0.5},
    'e':{start:60+55.00,dur:0.5},
    'ɛ':{start:60+59.00,dur:0.5},
    'æ':{start:2.80,dur:0.60},
    'ɑ':{start:3.50,dur:0.60},
    'ɔ':{start:4.20,dur:0.60},
    'o':{start:4.90,dur:0.60},
    'u':{start:5.60,dur:0.60},
    'ʊ':{start:6.30,dur:0.60},
    'ʌ':{start:7.00,dur:0.60},
    'ə':{start:7.70,dur:0.60},
    'ɚ':{start:8.40,dur:0.60},
    'ɝ':{start:9.10,dur:0.60},
    'aɪ':{start:9.80,dur:0.70},
    'aʊ':{start:10.60,dur:0.70},
    'ɔɪ':{start:11.40,dur:0.70},

    'p':{start:12.30,dur:0.50},
    'b':{start:13.50,dur:0.50},
    't':{start:15.50,dur:0.50},
    'd':{start:19.00,dur:0.50},
    'k':{start:23.00,dur:0.50},
    'g':{start:26.50,dur:0.50},
    'f':{start:30.00,dur:0.50},
    'v':{start:34.00,dur:0.50},
    'θ':{start:38.50,dur:0.50},
    'ð':{start:17.70,dur:0.55},
    's':{start:18.30,dur:0.50},
    'z':{start:18.90,dur:0.50},
    'ʃ':{start:19.50,dur:0.55},
    'ʒ':{start:20.15,dur:0.55},
    'tʃ':{start:20.85,dur:0.55},
    'dʒ':{start:21.50,dur:0.55},
    'h':{start:22.15,dur:0.45},
    'm':{start:22.65,dur:0.55},
    'n':{start:23.25,dur:0.55},
    'ŋ':{start:23.85,dur:0.55},
    'l':{start:24.45,dur:0.60},
    'r':{start:25.10,dur:0.60},
    'w':{start:25.75,dur:0.55},
    'j':{start:26.35,dur:0.55},
  };

  const gridV=document.getElementById('gridV');
  const gridC=document.getElementById('gridC');
  const statusEl=document.getElementById('status');
  const errorEl=document.getElementById('error');

  function tile(sym){
    const col=document.createElement('div');
    col.className='col-3 col-sm-2 col-md-1';
    const btn=document.createElement('button');
    btn.className='tile btn btn-outline-light w-100';
    btn.type='button'; btn.textContent=sym; btn.disabled=true;
    btn.addEventListener('click',()=>playSymbol(sym,{tile:btn}));
    col.appendChild(btn);
    return col;
  }
  function renderTiles(){
    gridV.innerHTML=''; gridC.innerHTML='';
    VOWELS.forEach(s=>gridV.appendChild(tile(s)));
    CONSONANTS.forEach(s=>gridC.appendChild(tile(s)));
  }
  renderTiles();

  let ctx,audioBuffer=null,currentSrc=null,currentGain=null;
  function getAC(){return window.AudioContext||window.webkitAudioContext;}
  async function ensureCtx(){if(!ctx){const AC=getAC();ctx=new AC();} if(ctx.state==='suspended')await ctx.resume(); return ctx;}
  function decodeWithFallback(context,arr){return new Promise((res,rej)=>{try{const p=context.decodeAudioData(arr,res,rej);if(p&&typeof p.then==='function'){p.then(res).catch(rej);}}catch(e){rej(e);}});}

  async function loadDefault(){
    try{
      await ensureCtx();
      statusEl.className='badge text-bg-warning'; statusEl.textContent='載入中…';
      const res=await fetch(DEFAULT_URL,{cache:'no-store'});
      if(!res.ok) throw new Error('下載失敗：HTTP '+res.status+'：'+DEFAULT_URL);
      const arr=await res.arrayBuffer();
      audioBuffer=await decodeWithFallback(ctx,arr);
      statusEl.className='badge text-bg-success';
      statusEl.textContent=`已載入 ✓ ${audioBuffer.duration.toFixed(2)}s @ ${audioBuffer.sampleRate}Hz`;
      document.querySelectorAll('.tile').forEach(b=> b.disabled=false);
    }catch(e){
      console.error(e);
      audioBuffer=null;
      statusEl.className='badge text-bg-danger'; statusEl.textContent='載入失敗';
      errorEl.textContent='錯誤：'+e.message; errorEl.classList.remove('d-none');
      document.querySelectorAll('.tile').forEach(b=> b.disabled=true);
    }
  }

  function stop(){
    if(currentSrc){ try{ currentSrc.stop(); }catch(_){} }
    if(currentGain){ try{ currentGain.disconnect(); }catch(_){} }
    currentSrc=null; currentGain=null;
    document.querySelectorAll('.tile.playing').forEach(el=>el.classList.remove('playing'));
  }

  function clamp(val,min,max){return Math.max(min,Math.min(max,val));}
  function playSymbol(sym,{tile=null}={}){
    if(!audioBuffer){alert('音檔尚未載入');return;}
    const seg=SEGMENTS[sym]; if(!seg){alert('未找到分段設定：'+sym);return;}
    stop();
    const start=clamp(seg.start,0,Math.max(0,audioBuffer.duration-0.01));
    const dur=Math.max(0.02,Math.min(seg.dur,audioBuffer.duration-start));
    const src=ctx.createBufferSource(); src.buffer=audioBuffer;
    src.playbackRate.value=1.0;
    const gain=ctx.createGain(); gain.gain.setValueAtTime(1,ctx.currentTime);
    src.connect(gain).connect(ctx.destination);
    const now=ctx.currentTime; gain.gain.setValueAtTime(1,now+dur-0.03); gain.gain.linearRampToValueAtTime(0.0001,now+dur);
    src.start(0,start,dur); currentSrc=src; currentGain=gain;
    if(tile){tile.classList.add('playing'); src.onended=()=>tile.classList.remove('playing');}
  }

  window.addEventListener('pointerdown',async()=>{try{await ensureCtx();}catch(_){}} ,{once:true});
  loadDefault();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>

