<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KK 音標</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      /* ★ 全站統一欄寬（總和 100%）— 加大字母欄、縮小音標欄 */
      --col-w-letters: 28%;
      --col-w-symbol : 10%;
      --col-w-desc   : 30%;
      --col-w-words  : 32%;
      --navbar-h     : 56px; /* navbar 高度，供滾動定位 */
    }

    html{scroll-behavior:smooth}
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}

    /* ---- TTS 控制欄（外框 + 同一列 + 白字） ---- */
    .tts-card{border:1px solid rgba(255,255,255,.25)}
    .tts-bar{display:flex;align-items:center;gap:.8rem;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .range-inline{width:280px;min-width:200px}
    .tts-select{min-width:260px}

    /* ---- 外框只包表格，不含大小標題 ---- */
    .table-frame{border:1px solid rgba(255,255,255,.2);border-radius:.6rem;overflow:hidden}
    .table-frame .table{margin-bottom:0}

    /* 每個小節自己的表格，固定版面以對齊欄位 */
    .section-table{table-layout:fixed;width:100%}
    .section-table thead th{position:sticky;top:0;z-index:1;background:#1b1f22}

    /* 大小標題（不在外框內、無 hover），並預留滾動定位空間 */
    .h1-title{color:#fff;font-weight:700;font-size:1.05rem;margin:1rem 0 .4rem; scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h2-title{color:#ced4da;font-weight:600;font-size:.95rem;margin:.5rem 0 .6rem; scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h1-title,.h2-title{user-select:text}

    /* 統一欄寬（所有表格共用） */
    .col-letters{width:var(--col-w-letters)}
    .col-symbol {width:var(--col-w-symbol)}
    .col-desc   {width:var(--col-w-desc)}
    .col-words  {width:var(--col-w-words)}

    /* 防止內容溢出重疊（超出以省略號） */
    .section-table th, .section-table td{overflow:hidden;text-overflow:ellipsis}

    /* 欄位內容樣式 */
    td.letters{white-space:nowrap}
    td.symbol{white-space:nowrap}            /* 音標不換行 */
    td.desc{color:#adb5bd;white-space:normal;word-break:break-word}
    td.words{white-space:normal;word-break:break-word}

    /* 互動（只在表格內作用） */
    td[data-play], .say-token{
      cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease
    }
    td[data-play]:hover, .say-token:hover{background-color:rgba(255,255,255,.06)}
    td[data-play]:active, .say-token:active{transform:scale(1.03)}
    .playing{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    /* ====== 單字範例欄位：一組(字+[])之間保留 gap；組內超貼 ====== */
    .word-group{
      display:flex;
      flex-wrap:wrap;
      gap:.35rem .6rem;          /* 組 與 組 之間 */
    }
    .pair{
      display:inline-flex;
      align-items:baseline;
      column-gap:.08rem;         /* 組內：英文字 與 [] 的距離（可依喜好調到 0） */
    }
    .pair .say-token{
      display:inline-block;
      padding:0 .1rem;
      border-radius:.25rem;
    }
    .pair .note{
      display:inline;
      color:#6c757d;
      font-size:.9rem;
      cursor:default;
      padding:0;
    }
    .pair .note:hover,.pair .note:active{background:transparent;transform:none}

    /* 章節目錄下拉（右上角） */
    .dropdown-menu-dark{--bs-dropdown-bg:#1f2428;--bs-dropdown-link-active-bg:#0d6efd}
    .dropdown-menu{max-height:70vh; overflow:auto}
    .toc-h2{padding-left:1.5rem}

    /* 小螢幕時再給字母欄多一點空間 */
    @media (max-width: 576px){
      :root{
        --col-w-letters: 32%;
        --col-w-symbol : 15%;
        --col-w-desc   : 23%;
        --col-w-words  : 30%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">KK 音標</span>
      <a href="https://dictionary.cambridge.org/help/phonetics.html" target="_blank" rel="noopener">
          KK 音標(參考連結)
      </a>
      <!-- 右側：章節目錄 Dropdown（不改網址） -->
      <div class="dropdown ms-auto">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                id="tocDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          章節目錄
        </button>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="tocDropdown" id="tocMenu"></ul>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <!-- ★ 英文語音 / 語速 控制列（同一列、白字、外框，設定可儲存） -->
    <div class="card tts-card mb-3 bg-dark text-white">
      <div class="card-body py-2">
        <div class="tts-bar">
          <span class="me-1">語音</span>
          <select id="selEn" class="form-select form-select-sm w-auto tts-select bg-dark text-white border-secondary"></select>
          <span>語速</span><span id="rateVal">1.00</span>
          <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00" />
        </div>
      </div>
    </div>

    <div id="content"></div> <!-- 大/小標題 + 多個表格外框都插在這 -->
    <audio id="player" preload="auto"></audio>
  </main>

  <!-- Bootstrap JS（啟用 dropdown） -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== 返回鍵 ======
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ====== TTS 控制（UI + 永續存取） ======
    const selEn   = document.getElementById('selEn');
    const rateEl  = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    let voices = [];

    function populateVoices(){
      voices = speechSynthesis.getVoices() || [];
      const list = voices
        .filter(v => v.lang && /^en/i.test(v.lang))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const saved = localStorage.getItem('tts.enVoice');
      selEn.innerHTML = '';
      list.forEach(v=>{
        const opt=document.createElement('option');
        opt.value = v.name + '||' + v.lang;
        opt.textContent = `${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if (saved && [...selEn.options].some(o=>o.value===saved)) selEn.value = saved;
      else if (list.length) selEn.value = list[0].value;
    }
    function getSavedVoice(){
      const saved = localStorage.getItem('tts.enVoice');
      if (!saved) return (voices.find(v=>/^en/i.test(v.lang)) || null);
      const [name,lang] = saved.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) || voices.find(v=>/^en/i.test(v.lang)) || null;
    }
    function getSavedRate(){
      const r = parseFloat(localStorage.getItem('tts.rate') || '1');
      return isNaN(r) ? 1 : r;
    }

    (function initRate(){
      const r = getSavedRate();
      rateEl.value = r.toFixed(2);
      rateVal.textContent = r.toFixed(2);
    })();
    rateEl.addEventListener('input', ()=>{
      const r = parseFloat(rateEl.value) || 1;
      rateVal.textContent = r.toFixed(2);
      localStorage.setItem('tts.rate', r);
    });
    selEn.addEventListener('change', ()=> localStorage.setItem('tts.enVoice', selEn.value));

    populateVoices();
    if ('onvoiceschanged' in speechSynthesis){
      speechSynthesis.onvoiceschanged = populateVoices;
    } else {
      setTimeout(populateVoices, 400);
    }

    // ====== 常數（內容解析） ======
    const TXT_URL    = 'content/kk.txt';   // Tab：字母/音標/mp3/start/end/發音/單字範例
    const AUDIO_BASE = 'audio/';

    const content  = document.getElementById('content');
    const tocMenu  = document.getElementById('tocMenu');
    const player   = document.getElementById('player');

    // ====== 讀取檔案 ======
    fetch(TXT_URL + '?c=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt => {
        const items = parseAll(txt); // [{type:'h1'|'h2'|'row'}...]
        render(items);
      })
      .catch(err => {
        console.warn('讀取失敗，使用示例資料：', err);
        const demo =
`<1>（一）母音音標
<2>單母音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
a\t[ æ ]\tkk.mp3\t0\t1.1\t短音的ㄟ\tcat [n.], hat
i\t[ ɪ ]\tkk.mp3\t1.2\t2.2\t短音的ㄧ\tit, ink [短音]

<2>雙母音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
ai\t[ aɪ ]\tkk.mp3\t2.3\t3.6\tㄞ\tbike [名詞], time

<1>（二）子音音標
<2>有聲子音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
b\t[ b ]\tkk.mp3\t3.7\t4.4\t有聲雙唇塞音\tbed, bad [反義]

<2>無聲子音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
p\t[ p ]\tkk.mp3\t4.5\t5.3\t清雙唇塞音\tpen [n.], pie`;
        const items = parseAll(demo);
        render(items);
      });

    // ====== 解析：任意位置的 <1>/<2> 與資料列 ======
    function parseAll(txt){
      const rawLines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n');
      const lines = rawLines.map(l => l.replace(/\s+$/,''));
      const items = [];
      for (const lineRaw of lines){
        const line = lineRaw.trim();
        if (!line) continue;

        const m1 = line.match(/^\s*<\s*1\s*>\s*(.+)$/);
        if (m1){ items.push({type:'h1', text: m1[1].trim()}); continue; }

        const m2 = line.match(/^\s*<\s*2\s*>\s*(.+)$/);
        if (m2){ items.push({type:'h2', text: m2[1].trim()}); continue; }

        if (!line.includes('\t')) continue; // 非標題、無 Tab → 略過

        const cols = splitCols(line);
        if (isHeaderRow(cols)) continue;    // 忽略來源 7 欄表頭

        while (cols.length < 7) cols.push('');
        const [letters, symbol, mp3, start, end, desc, word] = cols;
        if (!(letters||symbol||mp3||start||end||desc||word)) continue;

        items.push({
          type:'row',
          letters: (letters||'').trim(),
          symbol:  (symbol||'').trim(),
          mp3:     (mp3||'').trim(),
          start:   parseFloat((start||'').trim()),
          end:     parseFloat((end||'').trim()),
          desc:    (desc||'').trim(),
          word:    (word||'').trim(),
        });
      }
      return items;
    }

    // ---- 輔助：拆欄、表頭判斷（需命中 >=2 欄名才算表頭） ----
    function splitCols(line){
      return (line || '').split('\t').map(s => (s ?? '').trim());
    }
    function normalizeKey(s){
      return (s || '')
        .replace(/[／/]/g,'/')
        .replace(/\s+/g,'')
        .toLowerCase();
    }
    const HEADER_KEYS = new Set([
      '字母/字母組合','音標','mp3','start','end','發音','單字範例','單字','例字'
    ]);
    function isHeaderRow(cols){
      if (!cols || !cols.length) return false;
      const norm = cols.map(normalizeKey);
      const hits = norm.filter(c => HEADER_KEYS.has(c)).length;
      return hits >= 2;
    }

    // ====== 建一個新小節表格（獨立外框 + 統一欄寬） ======
    function createSectionTable(){
      const frame = document.createElement('div');
      frame.className = 'table-frame mb-3';

      const wrap = document.createElement('div');
      wrap.className = 'table-responsive m-0';
      frame.appendChild(wrap);

      const table = document.createElement('table');
      table.className = 'table table-dark table-hover align-middle section-table';
      table.innerHTML = `
        <colgroup>
          <col class="col-letters"><col class="col-symbol"><col class="col-desc"><col class="col-words">
        </colgroup>
        <thead>
          <tr>
            <th>字母／字母組合</th>
            <th>音標</th>
            <th>發音</th>
            <th>單字範例</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      wrap.appendChild(table);

      content.appendChild(frame);
      return table.querySelector('tbody');
    }

    // ====== 繪製（大標題/小標題在外；每個小標題後有自己的表格外框） ======
    function render(items){
      content.innerHTML = '';
      tocMenu.innerHTML = '';
      let currentTbody = null;
      const tocItems = [];
      let h1Count = 0, h2Count = 0;

      items.forEach(it=>{
        if (it.type === 'h1'){
          const h = document.createElement('div');
          h.className = 'h1-title';
          const id = `h1-${++h1Count}`;
          h.id = id;
          h.textContent = it.text || '';
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 1});
          currentTbody = null;
          return;
        }
        if (it.type === 'h2'){
          const h = document.createElement('div');
          h.className = 'h2-title';
          const id = `h2-${++h2Count}`;
          h.id = id;
          h.textContent = it.text || '';
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 2});
          currentTbody = createSectionTable();
          return;
        }
        if (it.type === 'row'){
          if (!currentTbody){
            currentTbody = createSectionTable();
          }
          currentTbody.appendChild(buildDataRow(it));
        }
      });

      buildTOC(tocItems);
    }

    // ====== 章節目錄（不改變網址；用 button 平滑捲動） ======
    function buildTOC(items){
      tocMenu.innerHTML = '';
      if (!items.length){
        const li = document.createElement('li');
        li.innerHTML = `<span class="dropdown-item-text text-secondary">（無章節）</span>`;
        tocMenu.appendChild(li);
        return;
      }
      items.forEach(({id, text, level})=>{
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item' + (level === 2 ? ' toc-h2' : '');
        btn.textContent = text;
        btn.addEventListener('click', () => {
          const el = document.getElementById(id);
          if (el){
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          const ddEl = document.getElementById('tocDropdown');
          const dropdown = bootstrap.Dropdown.getInstance(ddEl) || new bootstrap.Dropdown(ddEl);
          dropdown.hide();
        });
        li.appendChild(btn);
        tocMenu.appendChild(li);
      });
    }

    // ====== 資料列 ======
    function buildDataRow(r){
      const tr = document.createElement('tr');

      const tdLetters = document.createElement('td');
      tdLetters.className = 'letters';
      tdLetters.textContent = r.letters || '';
      tr.appendChild(tdLetters);

      const tdSymbol = document.createElement('td');
      tdSymbol.className = 'symbol';
      tdSymbol.innerHTML = `<b>${escapeHTML(r.symbol || '')}</b>`;
      const src = resolveAudio(r.mp3);
      if (r.symbol && src && Number.isFinite(r.start) && Number.isFinite(r.end) && r.end > r.start){
        tdSymbol.dataset.playSrc   = src;
        tdSymbol.dataset.playStart = String(r.start);
        tdSymbol.dataset.playEnd   = String(r.end);
        tdSymbol.setAttribute('data-play','');
        tdSymbol.addEventListener('click', onPlayCell);
      }
      tr.appendChild(tdSymbol);

      const tdDesc = document.createElement('td');
      tdDesc.className = 'desc';
      tdDesc.textContent = r.desc || '';
      tr.appendChild(tdDesc);

      const tdWord = document.createElement('td');
      tdWord.className = 'words';
      tdWord.appendChild(renderWordTokens(r.word || ''));
      tr.appendChild(tdWord);

      return tr;
    }

    // ====== 音標分段播放 ======
    let endTimer = null;
    let lastOnTimeUpdate = null;
    let currentPlayingEl = null;

    function onPlayCell(e){
      stopAll();
      const td = e.currentTarget;
      const src   = td.dataset.playSrc;
      const start = parseFloat(td.dataset.playStart);
      const end   = parseFloat(td.dataset.playEnd);
      if (!src || !Number.isFinite(start) || !Number.isFinite(end) || end<=start) return;

      currentPlayingEl = td;
      td.classList.add('playing');

      const go = ()=>{
        const seekAndPlay = ()=>{
          try{ player.currentTime = start; }catch{}
          player.play().catch(()=>{});
          lastOnTimeUpdate = ()=>{
            if (player.currentTime >= end - 0.02){
              stopPlayback();
            }
          };
          player.addEventListener('timeupdate', lastOnTimeUpdate);
          const dur = Math.max(0, (end - start) * 1000);
          endTimer = setTimeout(stopPlayback, dur + 60);
        };
        if (player.readyState >= 1) seekAndPlay();
        else player.addEventListener('loadedmetadata', seekAndPlay, {once:true});
      };

      if (player.src !== new URL(src, location.href).href){
        player.pause();
        player.src = src;
        go();
      }else{
        go();
      }
    }

    function stopPlayback(){
      try{ player.pause(); }catch{}
      if (currentPlayingEl){ currentPlayingEl.classList.remove('playing'); currentPlayingEl = null; }
      if (lastOnTimeUpdate){ player.removeEventListener('timeupdate', lastOnTimeUpdate); lastOnTimeUpdate = null; }
      clearTimeout(endTimer); endTimer = null;
    }

    // ====== 單字範例：把「英文字 + 後面 []」視為同一組 .pair ======
    function splitWords(s){
      const unified = s.replace(/[ \u3000]/g,' ').replace(/[，、；;／/|]/g, ',');
      return unified.split(',').map(t => t.trim()).filter(t => t);
    }

    function renderWordTokens(s){
      const group = document.createElement('div');
      group.className = 'word-group';
      const segments = splitWords(s); // 以逗號分段
      segments.forEach(seg=>{
        tokenizeSegmentIntoPairs(seg, group);
      });
      return group;
    }

    /**
     * 將一個片段（例："coat [n.]"、"bird blue [adj.]"、"[短音]"）拆成多個 .pair
     * 規則：
     *   - 每個英文字先生成一個 .pair（內含 .say-token）
     *   - 之後若遇到 [] 註記，就接到「最後一個 .pair」裡
     *   - 若開頭就是 []（沒有前字），則單獨成一個只含 .note 的 .pair
     */
    function tokenizeSegmentIntoPairs(segment, groupEl){
      const tokenRe = /\[[^\]]*\]/g;
      let lastIndex = 0, m;
      const tokens = [];

      while ((m = tokenRe.exec(segment)) !== null){
        if (m.index > lastIndex){
          tokens.push({type:'text', value: segment.slice(lastIndex, m.index)});
        }
        tokens.push({type:'note', value: m[0]}); // 含方括號
        lastIndex = m.index + m[0].length;
      }
      if (lastIndex < segment.length){
        tokens.push({type:'text', value: segment.slice(lastIndex)});
      }

      let lastPair = null;
      for (const tk of tokens){
        if (tk.type === 'text'){
          tk.value.split(/\s+/).map(w=>w.trim()).filter(Boolean).forEach(w=>{
            const pair = document.createElement('span');
            pair.className = 'pair';

            const word = document.createElement('span');
            word.className = 'say-token';
            word.textContent = w;
            word.addEventListener('click', ()=> sayToken(word, w));

            pair.appendChild(word);
            groupEl.appendChild(pair);
            lastPair = pair; // 讓接下來的 [] 可以掛到這一組
          });
        }else if (tk.type === 'note'){
          const note = document.createElement('span');
          note.className = 'note';
          note.textContent = tk.value;

          if (lastPair){
            lastPair.appendChild(note);
          }else{
            const pair = document.createElement('span');
            pair.className = 'pair';
            pair.appendChild(note);
            groupEl.appendChild(pair);
            lastPair = pair;
          }
        }
      }
    }

    // ====== TTS（讀取 UI 設定） ======
    function sayToken(el, text){
      stopAll();
      if (!text) return;
      const u = new SpeechSynthesisUtterance(text);
      const v = getSavedVoice();
      if (v) u.voice = v;
      u.lang = v?.lang || 'en-US';
      u.rate = getSavedRate();
      u.pitch=1; u.volume=1;

      el.classList.add('playing');
      u.onend = ()=> el.classList.remove('playing');
      u.onerror = ()=> el.classList.remove('playing');

      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    // ====== 共用 ======
    function stopAll(){ stopPlayback(); try{ speechSynthesis.cancel(); }catch{} }
    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function resolveAudio(mp3){
      if (!mp3) return '';
      if (/^(https?:)?\/\//i.test(mp3) || mp3.startsWith('/')) return mp3;
      return AUDIO_BASE + mp3;
    }
  </script>
</body>
</html>




