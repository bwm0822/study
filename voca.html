<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åœ‹å°å¿…å­¸ 500 å–®å­—+è£œå……</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* å…¨ç«™æš—è‰² */
    body{background:#212529;color:#f8f9fa}
    .container-narrow{max-width:980px}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}

    /* å…©æ¬„è¡¨æ ¼ï¼ˆç„¡è¡¨é ­ï¼‰ */
    .table { table-layout: fixed; }
    .idx-cell{width:72px; cursor:pointer; user-select:none}
    tr.group-start td{border-top-width:2px !important}

    /* æ¬¡è¦æ–‡å­— */
    .small-muted{color:#adb5bd;font-size:.9rem}

    /* å¯ç™¼éŸ³æ•ˆæœï¼ˆè‹±èªï¼‰ */
    [data-say]{cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    [data-say]:hover{background-color:rgba(255,255,255,.06)}
    [data-say]:active{transform:scale(1.03)}
    @media (prefers-reduced-motion: reduce){ [data-say]{transition:none} }
    .speaking{ outline:2px solid var(--bs-primary); box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2) }

    /* ç·¨è™Ÿæ¬„ä½ï¼šåŒä¸€æ ¼å…§å«ã€Œç´¢å¼•ã€èˆ‡ï¼ˆå¯éš±è—ï¼‰â˜… */
    .idx-wrap{display:flex;flex-direction:column;align-items:center;gap:.25rem}
    .idx-star{font-size:18px;line-height:1;color:#ff9800 !important}

    /* æ–‡å­—æ’ç‰ˆ */
    .word-line b{font-size:1.05rem}
    .kk{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; margin:0 .5rem; opacity:.95}

    .input-group .form-control.is-invalid{border-color:#dc3545}
    .range-inline{width:260px;min-width:180px}

    /* ğŸ” æœå°‹ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    .search-wrap{position:relative;}
    .search-menu{
      position:absolute; left:0; right:0; top:100%;
      z-index:1000; display:none;
      max-height:260px; overflow:auto;
      background:#1b1f22; border:1px solid rgba(255,255,255,.12);
      border-radius:.5rem; margin-top:.25rem;
    }
    .search-menu.show{display:block}
    .search-item{display:block; width:100%; text-align:left; padding:.35rem .75rem; border:0; background:transparent; color:#f8f9fa}
    .search-item:hover{background:rgba(255,255,255,.06)}
    .search-empty{padding:.5rem .75rem; color:#adb5bd}
    .search-word{font-weight:600}
    .search-zh{margin-left:.5rem; color:#adb5bd}

    /* é ‚éƒ¨å·¥å…·åˆ—ï¼šå³å´ç¾¤çµ„é å³ï¼›å¯æ›è¡Œå¾Œä»é å³ */
    #topBar{ gap:.5rem; }
    .right-tools{ min-width:220px; margin-left:auto; }

    /* ç¸®å°æ¬„ä½å¯¬åº¦ï¼ˆç·¨è™Ÿæœå°‹ï¼‹æœå°‹ï¼‰ */
    .jump-group{ width:120px; }
    .search-flex{ width:160px; }
    .search-wrap .input-group-text{ padding:.2rem .45rem; font-size:.85rem; }
    #searchClear{ padding:.2rem .45rem; }

    /* â• æ§åˆ¶åˆ—ï¼šèªéŸ³ / èªé€Ÿ / æ¨¡å¼ æ°¸é åŒä¸€åˆ—ï¼ˆçª„è¢å¹•æ©«å‘æ²å‹•ï¼‰ */
    .ctl-row{
      display:flex;
      flex-wrap:nowrap;             /* ä¸æ›è¡Œ */
      gap:.75rem;
      overflow-x:auto;              /* å°è¢å¹•å¯å·¦å³æ»‘å‹• */
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
    }
    .ctl-third{
      flex:0 0 auto;                /* ä¸å£“ç¸®ã€ä¸è‡ªå‹•æ›è¡Œ */
      min-width:260px;
    }
    .ctl-card{
      background:#171a1d; border:1px solid rgba(255,255,255,.12);
      border-radius:.75rem; padding:.6rem .75rem;
      white-space:nowrap;           /* å¡ç‰‡å…§å®¹ä¹Ÿä¸æ›è¡Œ */
    }

    /* æ–°å¢ï¼šæ¨™ç±¤èˆ‡æ§åˆ¶åŒä¸€è¡Œ */
    .ctl-inline{
      display:flex;
      align-items:center;
      gap:.5rem;
      white-space:nowrap;
    }
    .ctl-inline label{
      margin:0;
      font-size:.95rem;
      color:#f8f9fa; /* æ¨™ç±¤ç”¨ç™½è‰² */
    }

    /* æ¨¡å¼æŒ‰éˆ•ç¾¤ä¸æ›è¡Œ */
    .mode-btns{flex-wrap:nowrap;}
    .mode-btns .btn{min-width:4.5rem; white-space:nowrap}

    /* è©³ç´°æ¨¡å¼ä¸­çš„ä¾‹å¥è¡Œè·å°äº› */
    .ex-line{line-height:1.35}



    /* === å°ºå¯¸å¾®ç¸®ç‰ˆ === */

    /* èªéŸ³ä¸‹æ‹‰ï¼šç¸®å°å›ºå®šå¯¬åº¦ï¼Œä¸åƒæ»¿ */
    .ctl-inline select#selEn.form-select {
      width: 100%;          /* â† åŸæœ¬æœƒ 100% å¯¬ï¼Œæ”¹ç‚ºå›ºå®š */
      min-width: 140px;
      padding-top: .15rem;
      padding-bottom: .15rem;
    }

    /* èªé€Ÿæ‹‰æ¡¿ï¼šç¸®çŸ­ */
    .range-inline{
      width: 100%;          /* â† åŸ 260px */
      min-width: 120px;
    }

    /* æ¨¡å¼æŒ‰éˆ•ï¼šè®Šçª„ä¸€é» */
    .mode-btns .btn{
      min-width: 4.0rem;     /* â† åŸ 4.5rem */
      padding: .2rem .5rem;  /* è¼ƒç·Šæ¹Š */
      line-height: 1.1;
    }

    /* å¡ç‰‡å…§è¡Œé«˜æ›´ç·Šæ¹Šäº›ï¼ˆå¯é¸ï¼‰ */
    .ctl-card{ padding:.5rem .6rem; }
    .ctl-inline{ gap: .4rem; }

    /* è®“çª„è¢å¹•ä»å¯æ©«å‘æ²å‹•ï¼ˆä¿ç•™åŸæœ¬è¡Œç‚ºï¼‰ */
    .ctl-row{ gap: .6rem; }

  </style>
</head>
<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container container-narrow d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">è¿”å›</button>
      <span class="navbar-brand ms-3 mb-0 h1">åœ‹å°å¿…å­¸ 500 å–®å­—+è£œå……</span>
      <a href="https://translate.google.com/?sl=zh-TW&tl=en&op=translate" target="_blank" rel="noopener" class="ms-2">
          [google ç¿»è­¯]
      </a>
      <a href="https://www.youtube.com/watch?v=3MIIG-Nismg&list=PLWVa6dRSd4-p43iMczAy9iIeGzHMiJlfw" target="_blank" rel="noopener" class="ms-2">
          [èƒŒå–®å­—çš„æ–¹æ³•]
      </a>
      <div class="ms-auto d-flex gap-2">
        <button id="clearStarsBtn" class="btn btn-outline-warning btn-sm">æ¸…é™¤æ¨™è¨»</button>
      </div>
    </div>
  </nav>

  <main class="container container-narrow my-3">
    <!-- âœ… æ§åˆ¶åˆ—ï¼šèªéŸ³é¸æ“‡ / èªé€Ÿ / æ¨¡å¼ï¼ˆåŒä¸€åˆ—ï¼Œçª„è¢å¹•å¯æ©«å‘æ²å‹•ï¼‰ -->
    <div class="ctl-row mb-3">
      <!-- èªéŸ³ï¼ˆèªéŸ³[ä¸‹æ‹‰é¸å–®] åŒä¸€è¡Œï¼‰ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label for="selEn">èªéŸ³</label>
            <select id="selEn" class="form-select form-select-sm bg-dark text-light border-secondary"></select>
          </div>
        </div>
      </div>

      <!-- èªé€Ÿï¼ˆèªé€Ÿ[æ•¸å€¼][æ‹‰æ¡¿] åŒä¸€è¡Œï¼‰ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label for="rate">èªé€Ÿ</label>
            <span id="rateVal">1.00</span>
            <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00">
          </div>
        </div>
      </div>

      <!-- æ¨¡å¼ï¼ˆæ¨¡å¼[æŒ‰éˆ•ç¾¤] åŒä¸€è¡Œï¼‰ -->
      <div class="ctl-third">
        <div class="ctl-card">
          <div class="ctl-inline">
            <label>æ¨¡å¼</label>
            <div class="btn-group mode-btns" role="group" aria-label="modes">
              <button class="btn btn-primary btn-sm" data-mode="normal">æ­£å¸¸</button>
              <button class="btn btn-outline-light btn-sm" data-mode="zh">ä¸­æ–‡</button>
              <button class="btn btn-outline-light btn-sm" data-mode="en">è‹±æ–‡</button>
              <button class="btn btn-outline-light btn-sm" data-mode="voice">èªéŸ³</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ†é ï¼ˆå·¦ï¼‰ + ç·¨è™Ÿæœå°‹èˆ‡æ–‡å­—æœå°‹ï¼ˆå³ï¼‰ -->
    <nav id="topBar" class="mb-2 d-flex align-items-center flex-wrap">
      <ul id="pagination" class="pagination mb-2 mb-lg-0"></ul>

      <div class="right-tools d-flex align-items-center flex-wrap gap-2 justify-content-end">
        <!-- ç·¨è™Ÿæœå°‹ -->
        <div class="input-group input-group-sm jump-group">
          <input id="pageJump" type="number" class="form-control bg-dark text-light border-secondary" placeholder="ç·¨è™Ÿ">
          <button id="pageGo" class="btn btn-outline-light">Go</button>
        </div>

        <!-- ğŸ” é—œéµå­—æœå°‹ -->
        <div class="search-flex">
          <div class="search-wrap w-100">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark text-light border-secondary">&#x1F50D;&#xFE0E;</span>
              <input id="searchInput" type="text" class="form-control bg-dark text-light border-secondary" placeholder="" autocomplete="off">
              <button id="searchClear" class="btn btn-outline-light" title="æ¸…é™¤">Ã—</button>
            </div>
            <div id="searchMenu" class="search-menu"></div>
          </div>
        </div>
      </div>
    </nav>

    <!-- å…©æ¬„è¡¨æ ¼ -->
    <div class="table-responsive">
      <table id="voca" class="table table-dark table-hover align-middle mb-3">
        <tbody></tbody>
      </table>
    </div>

    <!-- ä¸‹æ–¹å¿«é€Ÿæ›é  -->
    <nav class="mt-2">
      <div id="quickPager" class="d-flex justify-content-center align-items-center gap-2 flex-wrap"></div>
    </nav>
  </main>

  <script>
    const EN_LANG = 'en-US';
    const pageSize = 10;

    const $tbody  = document.querySelector('#voca tbody');
    const $pagination = document.getElementById('pagination');
    const $selEn = document.getElementById('selEn');
    const $rate = document.getElementById('rate');
    const $rateVal = document.getElementById('rateVal');
    const $modeBtns = document.querySelector('.mode-btns');

    // ğŸ” æœå°‹ç›¸é—œ
    const $searchInput = document.getElementById('searchInput');
    const $searchMenu  = document.getElementById('searchMenu');
    const $searchClear = document.getElementById('searchClear');
    let searchIndex = [];        // {key, word, zh, i, idxValue}
    let highlightIdxValue = null;

    // æ¨¡å¼ï¼ˆä¸å„²å­˜ï¼Œé è¨­ normalï¼‰
    const Modes = { NORMAL:'normal', ZH:'zh', EN:'en', VOICE:'voice' };
    let currentMode = Modes.NORMAL;
    const detailRows = new Set();              // ç›®å‰é€²å…¥ã€Œè©³ç´°ã€çš„ idx é›†åˆ

    let voices = [];
    let rows = [];
    let rate = parseFloat(localStorage.getItem('tts.rate') || '1') || 1;

    // èµ·å§‹é ï¼ˆURL > localStorageï¼‰
    let currentPage = 1;
    const urlParams = new URLSearchParams(location.search);
    const urlPage = parseInt(urlParams.get('page'), 10);
    const savedPage = parseInt(localStorage.getItem('voca.currentPage') || '', 10);
    if (!isNaN(urlPage)  && urlPage  > 0) currentPage = urlPage;
    else if (!isNaN(savedPage) && savedPage > 0) currentPage = savedPage;

    /* ====== èªéŸ³ ====== */
    function loadVoices(){ voices = speechSynthesis.getVoices(); populateEnVoices(); }
    function populateEnVoices(){
      if (!voices.length) return;
      const enList = voices
        .filter(v => v.lang?.toLowerCase().startsWith('en'))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      fillSelect($selEn, enList, localStorage.getItem('tts.enVoice'));
      if (!$selEn.value && enList.length) $selEn.value = enList[0].name+'||'+enList[0].lang;
    }
    function fillSelect(sel, list, saved){
      sel.innerHTML = '';
      for(const v of list){
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' â˜…':''}`;
        sel.appendChild(opt);
      }
      if (saved && [...sel.options].some(o=>o.value===saved)) sel.value=saved;
    }
    loadVoices();
    if('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged=loadVoices;

    function getVoiceByValue(val){
      if(!val) return null;
      const [name,lang]=val.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) ||
             voices.find(v=>v.lang===lang) ||
             voices.find(v=>v.name===name) || null;
    }
    function speakEn(text, ondone){
      if(!text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang=EN_LANG;
      const chosen=getVoiceByValue($selEn.value);
      if(chosen) u.voice=chosen;
      u.rate=rate; u.pitch=1; u.volume=1;
      u.onend=()=>ondone&&ondone();
      u.onerror=()=>ondone&&ondone();
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    /* ====== å·¥å…· ====== */
    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function savePage(){
      try{
        localStorage.setItem('voca.currentPage', String(currentPage));
        const u = new URL(location.href);
        u.searchParams.set('page', currentPage);
        history.replaceState(null, '', u);
      }catch(e){}
    }
    function goPage(p){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      currentPage = Math.min(Math.max(1, p), totalPages);
      // æ›é æ™‚æ¸…ç©ºæ‰€æœ‰ã€Œè©³ç´°ã€åˆ—
      detailRows.clear();
      savePage();
      render();

      if (highlightIdxValue == null) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    /* ====== æ˜Ÿè™Ÿï¼ˆæ¨™è¨»ï¼‰ ====== */
    function loadStars(){
      try{
        const arr = JSON.parse(localStorage.getItem('voca.stars') || '[]');
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveStars(list){
      const nums = [], strs = [];
      for(const v of list){
        const n = Number(v);
        if (!Number.isNaN(n)) nums.push(n);
        else strs.push(String(v));
      }
      nums.sort((a,b)=>a-b);
      strs.sort();
      const merged = [...nums.map(n=>String(n)), ...strs];
      localStorage.setItem('voca.stars', JSON.stringify(merged));
      return merged;
    }
    function getStarsSet(){ return new Set(loadStars()); }
    function isStarred(idx){ return getStarsSet().has(String(idx)); }
    function toggleStar(idx){
      idx = String(idx);
      const set = getStarsSet();
      if(set.has(idx)) set.delete(idx); else set.add(idx);
      saveStars([...set]);
    }
    function clearAllStars(){ localStorage.setItem('voca.stars','[]'); }

    /* ====== è§£æ voca.txtï¼ˆ7 æ¬„ï¼‰ ====== */
    function parseTSV(txt){
      return txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n')
        .map(l=>l.trim()).filter(l=>l && !l.startsWith('#'))
        .map(line=>{
          const parts=line.split('\t').map(p=>(p??'').trim());
          const [idx, word, kk, zh, pos, exEn, exZh] = [
            parts[0]||'', parts[1]||'', parts[2]||'',
            parts[3]||'', parts[4]||'', parts[5]||'', parts[6]||''
          ];
          return { idx, word, kk, zh, pos, exEn, exZh };
        });
    }

    /* ====== åˆ†é  UI ====== */
    function renderPagination(){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      $pagination.innerHTML = '';

      const add = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
        if (!disabled) li.addEventListener('click', e => { e.preventDefault(); goPage(page); });
        $pagination.appendChild(li);
      };
      const addEllipsis = () => {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        li.innerHTML = `<span class="page-link">â€¦</span>`;
        $pagination.appendChild(li);
      };

      add('<<', Math.max(1, currentPage - 1), currentPage === 1);

      if (totalPages <= 10) {
        for (let i = 1; i <= totalPages; i++) add(i, i, false, i === currentPage);
      } else {
        const atStart = currentPage <= 9;
        const atEnd   = currentPage >= totalPages - 8;

        if (atStart) {
          for (let i = 1; i <= Math.min(9, totalPages-1); i++) add(i, i, false, i === currentPage);
          addEllipsis(); add(String(totalPages), totalPages, false, currentPage === totalPages);
        } else if (atEnd) {
          add('1', 1, false, currentPage === 1);
          addEllipsis();
          const start = Math.max(2, totalPages - 8);
          for (let i = start; i <= totalPages; i++) add(i, i, false, i === currentPage);
        } else {
          const start = Math.max(2, currentPage - 4);
          const end   = Math.min(totalPages - 1, start + 8);
          add('1', 1, false, currentPage === 1);
          if (start > 2) addEllipsis();
          for (let i = start; i <= end; i++) add(i, i, false, i === currentPage);
          if (end < totalPages - 1) addEllipsis();
          add(String(totalPages), totalPages, false, currentPage === totalPages);
        }
      }

      add('>>', Math.min(totalPages, currentPage + 1), currentPage === totalPages);

      const pageJump = document.getElementById('pageJump');
      const pageGo = document.getElementById('pageGo');
      if (pageJump) {
        // ä»¥ loadData è¨­å®šçš„ã€Œç·¨è™Ÿä¸Šä¸‹é™ã€ç‚ºæº–
        const go = () => {
          const minIdx = parseInt(pageJump.min, 10);
          const maxIdx = parseInt(pageJump.max, 10);
          const idxVal = parseInt((pageJump.value || '').trim(), 10);
          if (Number.isNaN(idxVal)) return;

          if ((Number.isFinite(minIdx) && idxVal < minIdx) ||
              (Number.isFinite(maxIdx) && idxVal > maxIdx)) {
            pageJump.classList.add('is-invalid');
            setTimeout(()=>pageJump.classList.remove('is-invalid'), 1200);
            return;
          }

          const targetIndex = rows.findIndex(r => String(r.idx) === String(idxVal));
          if (targetIndex >= 0) {
            const page = Math.floor(targetIndex / pageSize) + 1;
            highlightIdxValue = rows[targetIndex].idx;
            goPage(page);
          } else {
            pageJump.classList.add('is-invalid');
            setTimeout(()=>pageJump.classList.remove('is-invalid'), 1200);
          }
        };
        pageJump.onkeydown = (e) => { if (e.key === 'Enter') go(); };
        if (pageGo) pageGo.onclick = go;
      }
    }

    function renderQuickPager(){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      const qp = document.getElementById('quickPager');
      qp.innerHTML = '';
      if (totalPages <= 1) return;

      const makeBtn = (label, handler, disabled=false, primary=false) => {
        const btn = document.createElement('button');
        btn.className = `btn btn-sm ${primary?'btn-primary':'btn-outline-light'}`;
        btn.textContent = label;
        btn.disabled = !!disabled;
        if (handler) btn.addEventListener('click', handler);
        return btn;
      };

      if (currentPage <= 1) {
        qp.appendChild(makeBtn('1', null, true, true));
        qp.appendChild(makeBtn('>>', () => goPage(currentPage + 1)));
      } else {
        if (currentPage >= totalPages) {
          qp.appendChild(makeBtn('<<', () => goPage(currentPage - 1)));
          qp.appendChild(makeBtn(String(totalPages), null, true, true));
        } else {
          qp.appendChild(makeBtn('<<', () => goPage(currentPage - 1)));
          qp.appendChild(makeBtn(String(currentPage), null, true, true));
          qp.appendChild(makeBtn('>>', () => goPage(currentPage + 1)));
        }
      }
    }

    /* ====== ğŸ” æœå°‹ ====== */
    function buildSearchIndex(){
      searchIndex = rows.map((r,i)=>({
        key: (r.word||'').toLowerCase(),
        word: r.word || '',
        zh: r.zh || '',
        i,
        idxValue: r.idx
      }));
    }

    function showSearchMenu(items){
      $searchMenu.innerHTML = '';
      if (!items.length){
        const empty = document.createElement('div');
        empty.className='search-empty';
        empty.textContent='æ²’æœ‰ç¬¦åˆçš„å–®å­—';
        $searchMenu.appendChild(empty);
      }else{
        for(const it of items){
          const btn = document.createElement('button');
          btn.className='search-item';
          btn.type='button';
          btn.dataset.i = String(it.i);
          btn.dataset.idxValue = String(it.idxValue ?? '');
          btn.innerHTML = `<span class="search-word">${escapeHTML(it.word)}</span><span class="search-zh">${escapeHTML(it.zh)}</span>`;
          btn.addEventListener('click', ()=>{
            const i = Number(btn.dataset.i);
            if (!Number.isInteger(i) || i < 0 || i >= rows.length) { hideSearchMenu(); return; }
            const page = Math.floor(i / pageSize) + 1;
            highlightIdxValue = rows[i].idx;
            hideSearchMenu();
            $searchInput.blur();
            goPage(page);
          });
          $searchMenu.appendChild(btn);
        }
      }
      $searchMenu.classList.add('show');
    }
    function hideSearchMenu(){ $searchMenu.classList.remove('show'); }

    $searchInput.addEventListener('input', ()=>{
      const q = ($searchInput.value || '').trim().toLowerCase();
      if (!q){ hideSearchMenu(); return; }
      const matches = searchIndex
        .filter(it => it.key.startsWith(q))
        .sort((a,b)=> a.word.localeCompare(b.word,'en',{sensitivity:'base'}));
      showSearchMenu(matches.slice(0,30));
    });
    $searchInput.addEventListener('focus', ()=>{ $searchInput.dispatchEvent(new Event('input')); });
    $searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ hideSearchMenu(); $searchInput.blur(); }});
    $searchClear.addEventListener('click', ()=>{ $searchInput.value=''; hideSearchMenu(); $searchInput.focus(); });
    document.addEventListener('click', (e)=>{ if (!e.target.closest('.search-wrap')) hideSearchMenu(); });

    /* ====== æ¨¡å¼åˆ‡æ› ====== */
    $modeBtns.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;
      currentMode = btn.dataset.mode;
      // æ›´æ–°æŒ‰éˆ•æ¨£å¼
      [...$modeBtns.querySelectorAll('button')].forEach(b=>{
        if (b===btn){ b.classList.remove('btn-outline-light'); b.classList.add('btn-primary'); }
        else { b.classList.add('btn-outline-light'); b.classList.remove('btn-primary'); }
      });
      // åˆ‡æ¨¡å¼æ™‚æ¸…ç©ºæ‰€æœ‰è©³ç´°åˆ—
      detailRows.clear();
      render();
    });

    /* ====== è¡¨æ ¼é»æ“Šï¼ˆäº‹ä»¶å§”æ´¾ï¼‰ ====== */
    document.getElementById('voca').addEventListener('click',ev=>{
      // A) é»å·¦æ¬„ â†’ åˆ‡æ›æ¨™è¨»ï¼ˆâ˜…ï¼‰
      const idxCell = ev.target.closest('td.idx-cell');
      if (idxCell){
        const idx = idxCell.dataset.idx;
        toggleStar(idx);
        const star = idxCell.querySelector('.idx-star');
        if (star) star.hidden = !isStarred(idx);
        ev.stopPropagation();
        return;
      }

      // B) å…¶ä»–ï¼šè‹¥å¸¶ data-say ä¸”ç‚ºè‹±æ–‡ â†’ ç™¼éŸ³
      const el = ev.target.closest('[data-say]');
      if(!el) return;
      const isEn = (el.getAttribute('data-lang')||'').toLowerCase().startsWith('en');
      if(!isEn) return;
      const text = el.getAttribute('data-say') || el.textContent || '';
      el.classList.add('speaking');
      speakEn(text, ()=>el.classList.remove('speaking'));
    });

    document.getElementById('backBtn').addEventListener('click',()=>history.back());
    document.getElementById('clearStarsBtn').addEventListener('click',()=>{
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨™è¨»å—ï¼Ÿ')) return;
      clearAllStars();
      document.querySelectorAll('#voca .idx-star').forEach(el=>el.hidden=true);
    });

    // èªéŸ³è¨­å®š
    $selEn.addEventListener('change',()=>localStorage.setItem('tts.enVoice',$selEn.value));
    $rate.addEventListener('input',()=>{
      rate=parseFloat($rate.value)||1;
      $rateVal.textContent=rate.toFixed(2);
      localStorage.setItem('tts.rate',rate);
    });

    // æ”¯æ´ç€è¦½å™¨å‰é€²/å¾Œé€€ï¼šä¾ç¶²å€ ?page é‡æ–°æ¸²æŸ“
    window.addEventListener('popstate', () => {
      const p = parseInt(new URLSearchParams(location.search).get('page'), 10);
      if (!isNaN(p) && p !== currentPage) { currentPage = p; detailRows.clear(); render(); }
    });

    /* ====== æ¸²æŸ“ï¼šä¾æ¨¡å¼ç”Ÿæˆåˆ— ====== */
    function makeIdxCell(idx, starSet, rowSpan=1){
      const tdIdx=document.createElement('td');
      tdIdx.rowSpan=rowSpan;
      tdIdx.className='text-secondary small text-center align-middle idx-cell';
      tdIdx.dataset.idx = idx;

      const idxWrap = document.createElement('div');
      idxWrap.className = 'idx-wrap';
      const idxText = document.createElement('div');
      idxText.textContent = idx;
      const starSpan = document.createElement('div');
      starSpan.className = 'idx-star';
      starSpan.textContent = 'â˜…';
      starSpan.hidden = !starSet.has(String(idx));
      idxWrap.append(idxText, starSpan);
      tdIdx.appendChild(idxWrap);
      return tdIdx;
    }
    function makeToggleBtn(onClick){
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='btn btn-outline-light btn-sm';
      btn.textContent='åˆ‡æ›';
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); onClick(); });
      return btn;
    }

    function render(){
      $tbody.innerHTML='';
      const start=(currentPage-1)*pageSize;
      const pageRows=rows.slice(start,start+pageSize);
      const starSet = getStarsSet();

      for(const r of pageRows){
        const idx = escapeHTML(r.idx);
        const word= escapeHTML(r.word);
        const kk  = escapeHTML(r.kk);
        const zh  = escapeHTML(r.zh);
        const pos = escapeHTML(r.pos);
        const exEn= escapeHTML(r.exEn);
        const exZh= escapeHTML(r.exZh);

        const inDetail = detailRows.has(String(r.idx));

        /* ===== è©³ç´°ï¼ˆ3 è¡Œï¼Œæœ‰åˆ‡æ›éˆ•ï¼›é›¢é–‹è©³ç´°å›åˆ°ç›®å‰æ¨¡å¼ï¼‰ ===== */
        if (inDetail){
          const tr1=document.createElement('tr');
          tr1.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 3);

          const tdMain=document.createElement('td');
          tdMain.className='word-line';
          tdMain.setAttribute('data-say', r.word);
          tdMain.setAttribute('data-lang','en');

          const rightWrap = document.createElement('div');
          rightWrap.className='d-flex justify-content-between align-items-center gap-2';
          const leftInfo = document.createElement('div');
          leftInfo.innerHTML = `<b>${word}</b> <span class="kk small-muted">${kk}</span> <span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          const btn = makeToggleBtn(()=>{
            detailRows.delete(String(r.idx));
            render();
          });
          tdMain.appendChild(rightWrap);
          rightWrap.append(leftInfo, btn);

          tr1.append(tdIdx, tdMain);

          const tr2=document.createElement('tr');
          const tdExEn=document.createElement('td');
          tdExEn.className='ex-line';
          tdExEn.innerHTML = `<span class="small-muted">${exEn || ''}</span>`;
          if (r.exEn){
            tdExEn.setAttribute('data-say', r.exEn);
            tdExEn.setAttribute('data-lang','en');
          }
          tr2.append(tdExEn);

          const tr3=document.createElement('tr');
          const tdExZh=document.createElement('td');
          tdExZh.className='ex-line';
          tdExZh.innerHTML = `<span class="small-muted">${exZh || ''}</span>`;
          tr3.append(tdExZh);

          $tbody.append(tr1, tr2, tr3);
          continue;
        }

        /* ===== æ­£å¸¸æ¨¡å¼ï¼ˆ3 è¡Œï¼Œæ²’æœ‰åˆ‡æ›éˆ•ï¼‰ ===== */
        if (currentMode === Modes.NORMAL){
          const tr1=document.createElement('tr');
          tr1.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 3);
          const tdMain=document.createElement('td');
          tdMain.className='word-line';
          tdMain.setAttribute('data-say', r.word);
          tdMain.setAttribute('data-lang','en');
          tdMain.innerHTML = `<b>${word}</b> <span class="kk small-muted">${kk}</span> <span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          tr1.append(tdIdx, tdMain);

          const tr2=document.createElement('tr');
          const tdExEn=document.createElement('td');
          tdExEn.className='ex-line';
          tdExEn.innerHTML = `<span class="small-muted">${exEn || ''}</span>`;
          if (r.exEn){
            tdExEn.setAttribute('data-say', r.exEn);
            tdExEn.setAttribute('data-lang','en');
          }
          tr2.append(tdExEn);

          const tr3=document.createElement('tr');
          const tdExZh=document.createElement('td');
          tdExZh.className='ex-line';
          tdExZh.innerHTML = `<span class="small-muted">${exZh || ''}</span>`;
          tr3.append(tdExZh);

          $tbody.append(tr1, tr2, tr3);
          continue;
        }

        /* ===== ä¸­æ–‡æ¨¡å¼ï¼ˆ1 è¡Œï¼šç·¨è™Ÿ + ä¸­æ–‡ + è©æ€§ + åˆ‡æ›ï¼‰ ===== */
        if (currentMode === Modes.ZH){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);
          const td=document.createElement('td');

          const row = document.createElement('div');
          row.className='d-flex justify-content-between align-items-center gap-2';
          const left = document.createElement('div');
          left.innerHTML = `<span class="small">${zh}</span> <span class="small-muted">${pos}</span>`;
          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });
          row.append(left, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }

        /* ===== è‹±æ–‡æ¨¡å¼ï¼ˆ1 è¡Œï¼šç·¨è™Ÿ + è‹±æ–‡ + åˆ‡æ›ï¼‰ ===== */
        if (currentMode === Modes.EN){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);
          const td=document.createElement('td');

          const row = document.createElement('div');
          row.className='d-flex justify-content-between align-items-center gap-2';
          const left = document.createElement('div');
          left.setAttribute('data-say', r.word);
          left.setAttribute('data-lang', 'en');
          left.innerHTML = `<b>${word}</b>`;
          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });
          row.append(left, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }

        /* ===== èªéŸ³æ¨¡å¼ï¼ˆ1 è¡Œï¼šåƒ…ç·¨è™Ÿï¼›å³å´æ•´æ ¼å¯é»æ“Šæœ—è®€ï¼›å³å´ã€Œåˆ‡æ›ã€çœ‹è©³ç´°ï¼‰ ===== */
        if (currentMode === Modes.VOICE){
          const tr=document.createElement('tr');
          tr.className='group-start';

          const tdIdx = makeIdxCell(r.idx, starSet, 1);

          const td=document.createElement('td');
          // è®“æ•´å€‹å„²å­˜æ ¼éƒ½å¯ä»¥é»æ“Šæœ—è®€ï¼ˆé™¤äº†åˆ‡æ›éˆ•æœƒ stopPropagationï¼‰
          td.setAttribute('data-say', r.word);
          td.setAttribute('data-lang','en');
          td.style.cursor = 'pointer';

          // æ°´å¹³æ’åˆ—ï¼Œä¸æ›è¡Œ
          const row = document.createElement('div');
          row.className='d-flex flex-row flex-nowrap align-items-center justify-content-between gap-2';

          const speakArea = document.createElement('div');
          speakArea.className = 'flex-grow-1 text-secondary';
          speakArea.style.minHeight = '1.25rem';
          speakArea.title = 'é»æ­¤ç™¼éŸ³';
          speakArea.textContent = 'ğŸ”Š é»æ“Šç™¼éŸ³';

          const btn = makeToggleBtn(()=>{
            detailRows.add(String(r.idx));
            render();
          });

          row.append(speakArea, btn);
          td.appendChild(row);

          tr.append(tdIdx, td);
          $tbody.append(tr);
          continue;
        }
      }

      renderPagination();
      renderQuickPager();

      // ğŸ” è‹¥å‰›å¾æœå°‹è·³ä¾†ï¼šé«˜äº®ä¸¦æ²åˆ°ä¸­é–“
      if (highlightIdxValue != null){
        const selector = `td.idx-cell[data-idx="${CSS.escape(String(highlightIdxValue))}"]`;
        const cell = document.querySelector(selector);
        if (cell){
          cell.classList.add('speaking');
          requestAnimationFrame(() => {
            cell.scrollIntoView({ behavior:'smooth', block:'center' });
          });
          setTimeout(()=>cell.classList.remove('speaking'), 900);
        }
        highlightIdxValue = null;
      }
    }

    // åˆå§‹åŒ–
    (function init(){
      $rate.value=rate.toFixed(2);
      $rateVal.textContent=rate.toFixed(2);
      loadData();
    })();

    async function loadData(){
      try{
        const res=await fetch('content/voca.txt?c='+Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text=await res.text();
        rows=parseTSV(text);
        buildSearchIndex();

        /* âœ… è¨­å®šã€Œç·¨è™Ÿæœå°‹ã€çš„ä¸Šä¸‹é™èˆ‡ placeholderï¼ˆä¾ voca.txt çš„æœ€å°/æœ€å¤§ idxï¼‰ */
        const pageJump = document.getElementById('pageJump');
        if (pageJump) {
          const idxNums = rows.map(r => parseInt(r.idx, 10)).filter(n => !Number.isNaN(n));
          if (idxNums.length) {
            const minIdx = Math.min(...idxNums);
            const maxIdx = Math.max(...idxNums);
            pageJump.min = String(minIdx);
            pageJump.max = String(maxIdx);
            pageJump.placeholder = `${minIdx}~${maxIdx}`;
          }
        }

        const totalPages=Math.ceil(rows.length/pageSize)||1;
        if (currentPage>totalPages) currentPage=totalPages;
        if (currentPage<1) currentPage=1;
        savePage();

        render();
      }catch(err){alert('è®€å–å¤±æ•—ï¼š'+err.message);}
    }
  </script>
</body>
</html>
















