<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocabulary TTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#fff}
    .table thead th{position:sticky;top:0;background:#f8f9fa;z-index:1}
    td[data-say]{cursor:pointer}
    td[data-say].speaking{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.15)}
    .container-narrow{max-width:980px}
    tr.group-start td{border-top-width:2px !important}
    th.col-word{width:220px}
    th.col-ex{width:auto}
    th.col-idx{width:72px}
    td.small-muted{color:#6c757d;font-size:.9rem}
    .input-group .form-control.is-invalid{border-color:#dc3545}
  </style>
</head>
<body>
  <!-- 導覽列 -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <div class="container container-narrow d-flex justify-content-start">
      <button id="backBtn" class="btn btn-outline-secondary btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">國小必學 500 單字</span>
    </div>
  </nav>

  <main class="container container-narrow my-3">
    <!-- 語音控制列 -->
    <div class="card mb-3">
      <div class="card-body row gy-2 gx-3 align-items-center">
        <div class="col-12 col-md-4">
          <label class="form-label mb-1">英文語音</label>
          <select id="selEn" class="form-select form-select-sm"></select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label mb-1">中文語音</label>
          <select id="selZh" class="form-select form-select-sm"></select>
        </div>
        <div class="col-12 col-md-4">
          <label for="rate" class="form-label mb-1">語速：<span id="rateVal">1.00</span></label>
          <input id="rate" type="range" class="form-range" min="0.5" max="2.0" step="0.05" value="1.00">
        </div>
      </div>
    </div>

    <!-- 分頁控制（上方） -->
    <nav class="mb-2 d-flex justify-content-center align-items-center gap-2 flex-wrap">
      <ul id="pagination" class="pagination mb-0"></ul>
      <div class="input-group input-group-sm" style="width:170px">
        <input id="pageJump" type="number" class="form-control" min="1" placeholder="直接輸入頁碼">
        <button id="pageGo" class="btn btn-outline-secondary">Go</button>
      </div>
    </nav>

    <!-- 單字表格（三列一組） -->
    <div class="table-responsive">
      <table id="voca" class="table table-hover align-middle mb-3">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th class="col-word">單字 / 中文 / 詞性</th>
            <th class="col-ex">例句（英 / 中）</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 最下面：上下頁控制（第一頁：1 >>；中間：<< 頁數 >>；最後：<< last） -->
    <nav class="mt-2">
      <div id="quickPager" class="d-flex justify-content-center align-items-center gap-2 flex-wrap"></div>
    </nav>
  </main>

  <script>
    const EN_LANG = 'en-US';
    const ZH_LANG = 'zh-TW';
    const pageSize = 25;

    const $tbody  = document.querySelector('#voca tbody');
    const $pagination = document.getElementById('pagination');
    const $selEn = document.getElementById('selEn');
    const $selZh = document.getElementById('selZh');
    const $rate = document.getElementById('rate');
    const $rateVal = document.getElementById('rateVal');

    let voices = [];
    let rows = [];
    let rate = parseFloat(localStorage.getItem('tts.rate') || '1') || 1;

    // 讀取起始頁：先看 URL ?page=，否則用 localStorage
    let currentPage = 1;
    const urlParams = new URLSearchParams(location.search);
    const urlPage = parseInt(urlParams.get('page'), 10);
    const savedPage = parseInt(localStorage.getItem('voca.currentPage') || '', 10);
    if (!isNaN(urlPage)  && urlPage  > 0) currentPage = urlPage;
    else if (!isNaN(savedPage) && savedPage > 0) currentPage = savedPage;

    // --- 語音載入 ---
    function loadVoices(){
      voices = speechSynthesis.getVoices();
      populateVoiceSelects();
    }
    function populateVoiceSelects(){
      if (!voices.length) return;
      const enList = voices.filter(v => v.lang?.toLowerCase().startsWith('en'));
      const zhList = voices.filter(v => /^(zh|cmn)/i.test(v.lang));
      fillSelect($selEn, enList, localStorage.getItem('tts.enVoice'));
      fillSelect($selZh, zhList, localStorage.getItem('tts.zhVoice'));
      if (!$selEn.value && enList.length) $selEn.value = enList[0].name+'||'+enList[0].lang;
      if (!$selZh.value && zhList.length) $selZh.value = zhList[0].name+'||'+zhList[0].lang;
    }
    function fillSelect(sel, list, saved){
      sel.innerHTML = '';
      list.sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      for(const v of list){
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' ★':''}`;
        sel.appendChild(opt);
      }
      if (saved && [...sel.options].some(o=>o.value===saved)) sel.value=saved;
    }
    loadVoices();
    if('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged=loadVoices;

    // --- TTS ---
    function getVoiceByValue(val){
      if(!val) return null;
      const [name,lang]=val.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) ||
             voices.find(v=>v.lang===lang) ||
             voices.find(v=>v.name===name) || null;
    }
    function speak(text, lang, ondone){
      if(!text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang=lang;
      const sel=(lang.startsWith('zh')?$selZh.value:$selEn.value);
      const chosen=getVoiceByValue(sel);
      if(chosen) u.voice=chosen;
      u.rate=rate; u.pitch=1; u.volume=1;
      u.onend=()=>ondone&&ondone();
      u.onerror=()=>ondone&&ondone();
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    // --- 工具 ---
    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function savePage(){
      try{
        localStorage.setItem('voca.currentPage', String(currentPage));
        const u = new URL(location.href);
        u.searchParams.set('page', currentPage);
        history.replaceState(null, '', u);
      }catch(e){/* ignore */}
    }
    function goPage(p){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      currentPage = Math.min(Math.max(1, p), totalPages);
      savePage(); // 記錄並同步網址
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 解析 voca.txt：支援 6 欄（idx, en, zh, pos, exEn, exZh）；容忍舊 4 欄（idx, en, zh, exEn）
    function parseTSV(txt){
      return txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n')
        .map(l=>l.trim()).filter(l=>l && !l.startsWith('#'))
        .map(line=>{
          const parts=line.split('\t');
          const [idx,en,zh,pos,exEn,exZh] = [
            parts[0]||'', parts[1]||'', parts[2]||'',
            (parts[3]||''), (parts[4]||parts[3]||''), (parts[5]||'')
          ];
          let _pos = pos, _exEn = exEn, _exZh = exZh;
          if (parts.length===4){ _pos=''; _exEn=parts[3]; _exZh=''; }
          return {idx,en,zh,pos:_pos,exEn:_exEn,exZh:_exZh};
        });
    }

    // --- 渲染（三列一筆） ---
    function render(){
      $tbody.innerHTML='';
      const start=(currentPage-1)*pageSize;
      const pageRows=rows.slice(start,start+pageSize);

      for(const r of pageRows){
        const idx = escapeHTML(r.idx);
        const en  = escapeHTML(r.en);
        const zh  = escapeHTML(r.zh);
        const pos = escapeHTML(r.pos);
        const exEn= escapeHTML(r.exEn);
        const exZh= escapeHTML(r.exZh);

        // 第一列
        const tr1=document.createElement('tr');
        tr1.className='group-start';
        const tdIdx=document.createElement('td');
        tdIdx.rowSpan=3;
        tdIdx.className='text-muted small text-center align-middle';
        tdIdx.textContent=idx;

        const tdEn=document.createElement('td');
        tdEn.innerHTML = `<b>${en}</b>`;
        tdEn.setAttribute('data-say', r.en);
        tdEn.setAttribute('data-lang','en');

        const tdExEn=document.createElement('td');
        tdExEn.textContent = r.exEn || '';
        if (r.exEn){
          tdExEn.setAttribute('data-say', r.exEn);
          tdExEn.setAttribute('data-lang','en');
        }
        tr1.append(tdIdx, tdEn, tdExEn);

        // 第二列
        const tr2=document.createElement('tr');
        const tdZh=document.createElement('td');
        tdZh.className='small-muted';
        tdZh.textContent = zh;
        const tdExZh=document.createElement('td');
        tdExZh.className='small-muted';
        tdExZh.textContent = exZh || '';
        tr2.append(tdZh, tdExZh);

        // 第三列
        const tr3=document.createElement('tr');
        const tdPos=document.createElement('td');
        tdPos.className='small-muted';
        tdPos.textContent = pos || '';
        const tdEmpty=document.createElement('td');
        tdEmpty.textContent = '';
        tr3.append(tdPos, tdEmpty);

        $tbody.append(tr1, tr2, tr3);
      }

      renderPagination();
      renderQuickPager();
    }

    // --- 分頁邏輯（>10頁三種樣式） ---
    function renderPagination(){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      $pagination.innerHTML = '';

      const add = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
        if (!disabled) {
          li.addEventListener('click', e => {
            e.preventDefault();
            goPage(page);
          });
        }
        $pagination.appendChild(li);
      };
      const addEllipsis = () => {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        li.innerHTML = `<span class="page-link">…</span>`;
        $pagination.appendChild(li);
      };

      // << 上一頁
      add('<<', Math.max(1, currentPage - 1), currentPage === 1);

      if (totalPages <= 10) {
        for (let i = 1; i <= totalPages; i++) add(i, i, false, i === currentPage);
      } else {
        const atStart = currentPage <= 9;              // 1..9 … n
        const atEnd   = currentPage >= totalPages - 8; // 1 … n-8..n

        if (atStart) {
          for (let i = 1; i <= Math.min(9, totalPages-1); i++) add(i, i, false, i === currentPage);
          addEllipsis();
          add(String(totalPages), totalPages, false, currentPage === totalPages);
        } else if (atEnd) {
          add('1', 1, false, currentPage === 1);
          addEllipsis();
          const start = Math.max(2, totalPages - 8);
          for (let i = start; i <= totalPages; i++) add(i, i, false, i === currentPage);
        } else {
          const start = Math.max(2, currentPage - 4);       // m
          const end   = Math.min(totalPages - 1, start + 8);
          add('1', 1, false, currentPage === 1);
          if (start > 2) addEllipsis();
          for (let i = start; i <= end; i++) add(i, i, false, i === currentPage);
          if (end < totalPages - 1) addEllipsis();
          add(String(totalPages), totalPages, false, currentPage === totalPages);
        }
      }

      // >> 下一頁
      add('>>', Math.min(totalPages, currentPage + 1), currentPage === totalPages);

      // 直接輸入跳頁
      const pageJump = document.getElementById('pageJump');
      const pageGo = document.getElementById('pageGo');
      if (pageJump) {
        pageJump.max = totalPages;
        const go = () => {
          const p = parseInt(pageJump.value, 10);
          if (!isNaN(p) && p >= 1 && p <= totalPages) goPage(p);
          else {
            pageJump.classList.add('is-invalid');
            setTimeout(()=>pageJump.classList.remove('is-invalid'), 1200);
          }
        };
        pageJump.onkeydown = (e) => { if (e.key === 'Enter') go(); };
        if (pageGo) pageGo.onclick = go;
      }
    }

    // --- 最下面：上下頁控制（第一頁：1 >>；中間：<< 頁數 >>；最後：<< last） ---
    function renderQuickPager(){
      const totalPages = Math.ceil(rows.length / pageSize) || 1;
      const qp = document.getElementById('quickPager');
      qp.innerHTML = '';
      if (totalPages <= 1) return;

      const makeBtn = (label, handler, disabled=false, primary=false) => {
        const btn = document.createElement('button');
        btn.className = `btn btn-sm ${primary?'btn-primary':'btn-outline-secondary'}`;
        btn.textContent = label;
        btn.disabled = !!disabled;
        if (handler) btn.addEventListener('click', handler);
        return btn;
      };

      if (currentPage <= 1) {
        // 第一頁：1 >>
        qp.appendChild(makeBtn('1', null, true, true));
        qp.appendChild(makeBtn('>>', () => goPage(currentPage + 1)));
      } else if (currentPage >= totalPages) {
        // 最後一頁：<< last
        qp.appendChild(makeBtn('<<', () => goPage(currentPage - 1)));
        qp.appendChild(makeBtn('last', null, true, true));
      } else {
        // 中間頁：<< 頁數 >>
        qp.appendChild(makeBtn('<<', () => goPage(currentPage - 1)));
        qp.appendChild(makeBtn(String(currentPage), null, true, true));
        qp.appendChild(makeBtn('>>', () => goPage(currentPage + 1)));
      }
    }

    async function loadData(){
      try{
        const res=await fetch('content/voca.txt?c='+Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text=await res.text();
        rows=parseTSV(text);

        // 修正目前頁碼不超界並記錄
        const totalPages=Math.ceil(rows.length/pageSize)||1;
        if (currentPage>totalPages) currentPage=totalPages;
        if (currentPage<1) currentPage=1;
        savePage();

        render();
      }catch(err){alert('讀取失敗：'+err.message);}
    }

    // --- 事件 ---
    document.getElementById('voca').addEventListener('click',ev=>{
      const td=ev.target.closest('td[data-say]');
      if(!td) return;
      const text=td.getAttribute('data-say')||td.textContent||'';
      const lang=td.getAttribute('data-lang')==='en'?EN_LANG:ZH_LANG;
      if(lang!==EN_LANG) return; // 只讓英文發音
      td.classList.add('speaking');
      speak(text,lang,()=>td.classList.remove('speaking'));
    });
    document.getElementById('backBtn').addEventListener('click',()=>history.back());
    $selEn.addEventListener('change',()=>localStorage.setItem('tts.enVoice',$selEn.value));
    $selZh.addEventListener('change',()=>localStorage.setItem('tts.zhVoice',$selZh.value));
    $rate.addEventListener('input',()=>{
      rate=parseFloat($rate.value)||1;
      $rateVal.textContent=rate.toFixed(2);
      localStorage.setItem('tts.rate',rate);
    });

    // 支援瀏覽器前進/後退：依網址 ?page 重新渲染
    window.addEventListener('popstate', () => {
      const p = parseInt(new URLSearchParams(location.search).get('page'), 10);
      if (!isNaN(p) && p !== currentPage) {
        currentPage = p;
        render();
      }
    });

    // 初始化
    $rate.value=rate.toFixed(2);
    $rateVal.textContent=rate.toFixed(2);
    loadData();
  </script>
</body>
</html>



