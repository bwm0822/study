<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <base href="/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>不規則動詞表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}
    .table thead th{position:sticky;top:0;z-index:1;background:#1b1f22}
    td.kind{white-space:nowrap}
    tr.cn td{color:#adb5bd}

    /* 點英文會發音 */
    td[data-say]{cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    td[data-say]:hover{background-color:rgba(255,255,255,.06)}
    td[data-say]:active{transform:scale(1.03)}
    td.speaking{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    /* 縮小語速 bar */
    .range-inline{width:140px;min-width:110px}

    /* 精簡搜尋：🔍︎[輸 入][x] */
    .search-wrap{flex:0 1 240px}
    .form-control-dark{background:#1b1f22;color:#e9ecef;border:1px solid rgba(255,255,255,.18)}
    .form-control-dark::placeholder{color:#adb5bd}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:#e9ecef}
    .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .search-icon{user-select:none}

    /* 目標列高亮 */
    tr.jump-highlight td{outline:2px solid var(--bs-primary); box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">不規則動詞表</span>
      <span id="loadInfo" class="ms-auto small text-secondary">資料載入中…</span>
    </div>
  </nav>

  <main class="container py-3">
    <!-- 英文語音 + 語速 + 精簡搜尋（同一列） -->
    <div class="card mb-3 bg-dark text-light border-secondary">
      <div class="card-body">
        <div class="d-flex align-items-center flex-wrap gap-3">
          <label class="form-label mb-0">語音</label>
          <select id="selEn" class="form-select form-select-sm w-auto bg-dark text-light border-secondary"></select>

          <span for="rate" class="form-label mb-0">語速</span><span id="rateVal">1.00</span>
          <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00">

          <!-- 🔍︎[輸 入][x] -->
          <div class="search-wrap ms-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text btn-ghost search-icon">&#x1F50D;&#xFE0E;</span>
              <input id="q" type="search" class="form-control form-control-dark" placeholder="輸入" list="baseList" autocomplete="off">
              <datalist id="baseList"></datalist>
              <button id="clearQ" class="btn btn-ghost" type="button" title="清除">x</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tbl" class="table table-dark table-hover align-middle">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // ====== 返回鍵 ======
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ====== 語音 ======
    const selEn   = document.getElementById('selEn');
    const rateEl  = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    const loadInfo= document.getElementById('loadInfo');

    let voices = [];
    let rate = parseFloat(localStorage.getItem('tts.rate') || '1') || 1;

    function loadVoices(){
      voices = speechSynthesis.getVoices();
      const list = voices
        .filter(v => v.lang && v.lang.toLowerCase().startsWith('en'))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const saved = localStorage.getItem('tts.enVoice');
      selEn.innerHTML = '';
      list.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if (saved && [...selEn.options].some(o=>o.value===saved)) selEn.value=saved;
      else if (list.length) selEn.value=list[0].value;
    }
    function getVoice(val){
      if(!val) return null;
      const [name,lang]=val.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) ||
             voices.find(v=>v.lang===lang) || null;
    }
    function speakEn(text){
      if(!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      const voice = getVoice(selEn.value);
      if (voice) u.voice = voice;
      u.rate = rate; u.pitch=1; u.volume=1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }
    rateEl.value = rate.toFixed(2);
    rateVal.textContent = rate.toFixed(2);
    rateEl.addEventListener('input', ()=>{
      rate = parseFloat(rateEl.value)||1;
      rateVal.textContent = rate.toFixed(2);
      localStorage.setItem('tts.rate', rate);
    });
    selEn.addEventListener('change', ()=>localStorage.setItem('tts.enVoice', selEn.value));
    loadVoices();
    if ('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = loadVoices;

    // ====== 表格資料 ======
    const theadRow = document.getElementById('theadRow');
    const tbody    = document.getElementById('tbody');

    const baseIndex = new Map(); // base(lower) -> tr
    let allRows = [];

    fetch('/content/irregular.txt?c='+Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt => {
        allRows = parseTSV(txt);
        buildThead(['中譯','原形動詞','過去式','過去分詞']);
        render(allRows);
        loadInfo.textContent = `共 ${allRows.length} 筆`;
      })
      .catch(err => loadInfo.textContent = '讀取失敗：' + err.message);

    function parseTSV(txt){
      const lines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n').filter(l => l.trim() !== '');
      if (!lines.length) return [];
      const data = lines.map(line => line.split('\t').map(s=>s.trim()));
      const body = data[0].some(c => /中譯|原形|過去|過去分詞/.test(c)) ? data.slice(1) : data;
      return body.map(cols => [cols[0]||'', cols[1]||'', cols[2]||'', cols[3]||'']).filter(row => row.some(v => v));
    }

    function buildThead(header){
      theadRow.innerHTML='';
      header.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h || '';
        theadRow.appendChild(th);
      });
    }

    function render(rows){
      tbody.innerHTML='';
      baseIndex.clear();
      const frag = document.createDocumentFragment();
      rows.forEach(([cn, base, past, part])=>{
        const tr = document.createElement('tr');

        const tdCN = document.createElement('td'); tdCN.textContent = cn; tr.appendChild(tdCN);

        const tdBase = document.createElement('td');
        tdBase.innerHTML = `<b>${escapeHTML(base)}</b>`;
        tdBase.setAttribute('data-say', base);
        tdBase.addEventListener('click', onSpeakCell);
        tr.appendChild(tdBase);

        const tdPast = document.createElement('td');
        tdPast.innerHTML = `<b>${escapeHTML(past)}</b>`;
        tdPast.setAttribute('data-say', past);
        tdPast.addEventListener('click', onSpeakCell);
        tr.appendChild(tdPast);

        const tdPart = document.createElement('td');
        tdPart.innerHTML = `<b>${escapeHTML(part)}</b>`;
        tdPart.setAttribute('data-say', part);
        tdPart.addEventListener('click', onSpeakCell);
        tr.appendChild(tdPart);

        const key = String(base||'').trim().toLowerCase();
        if (key && !baseIndex.has(key)) baseIndex.set(key, tr);

        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function onSpeakCell(e){
      const td = e.currentTarget;
      const text = td.getAttribute('data-say') || td.textContent.trim();
      if (!text) return;
      td.classList.add('speaking');
      speakEn(text);
      setTimeout(()=>td.classList.remove('speaking'), 300);
    }

    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    // ====== 精簡搜尋（🔍︎[輸 入][x]；空字串不出選項） ======
    const q = document.getElementById('q');
    const baseList = document.getElementById('baseList');
    const clearQ = document.getElementById('clearQ');

    function filterDatalistToPrefix(prefix){
      const p = String(prefix||'').toLowerCase();
      baseList.innerHTML = '';
      if (!p) return;
      const all = Array.from(new Set(allRows.map(r => String(r[1]||'').trim()).filter(Boolean)));
      const list = all.filter(b => b.toLowerCase().startsWith(p))
                      .sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'}));
      list.forEach(b=>{
        const opt = document.createElement('option');
        opt.value = b;
        baseList.appendChild(opt);
      });
    }

    q.addEventListener('input', ()=> filterDatalistToPrefix(q.value));
    q.addEventListener('change', ()=> jumpToBase(q.value));
    q.addEventListener('keydown', ev=>{
      if (ev.key==='Enter'){ev.preventDefault();jumpToBase(q.value);}
    });
    clearQ.addEventListener('click', ()=>{q.value='';baseList.innerHTML='';q.focus();});

    function jumpToBase(val){
      const raw = String(val||'').trim().toLowerCase();
      if (!raw) return;
      let tr = baseIndex.get(raw);
      if (!tr){
        const key = Array.from(baseIndex.keys()).find(k => k.startsWith(raw));
        if (key) tr = baseIndex.get(key);
      }
      if (!tr) return;
      tr.scrollIntoView({behavior:'smooth',block:'center'});
      tr.classList.add('jump-highlight');
      setTimeout(()=>tr.classList.remove('jump-highlight'),1200);
    }
  </script>
</body>
</html>









