
<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <base href="/study/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>代名詞表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}
    .table thead th{position:sticky;top:0;z-index:1;background:#1b1f22}
    td.kind{white-space:nowrap}
    tr.cn td{color:#adb5bd}

    /* 點英文會發音 */
    td[data-say]{cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    td[data-say]:hover{background-color:rgba(255,255,255,.06)}
    td[data-say]:active{transform:scale(1.03)}
    td.speaking{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    .range-inline{width:260px;min-width:180px}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">代名詞表</span>
      <span id="loadInfo" class="ms-auto small text-secondary">資料載入中…</span>
    </div>
  </nav>

  <main class="container py-3">
    <!-- 英文語音 + 語速（同一列） -->
    <div class="card mb-3 bg-dark text-light border-secondary">
      <div class="card-body">
        <div class="d-flex align-items-center flex-wrap gap-3">
          <label class="form-label mb-0">語音</label>
          <select id="selEn" class="form-select form-select-sm w-auto bg-dark text-light border-secondary"></select>

          <span for="rate" class="form-label mb-0">語速</span><span id="rateVal">1.00</span>
          <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00">
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tbl" class="table table-dark table-hover align-middle">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // ====== 返回鍵 ======
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ====== 語音 ======
    const selEn   = document.getElementById('selEn');
    const rateEl  = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    const loadInfo= document.getElementById('loadInfo');

    let voices = [];
    let rate = parseFloat(localStorage.getItem('tts.rate') || '1') || 1;

    function loadVoices(){
      voices = speechSynthesis.getVoices();
      const list = voices
        .filter(v => v.lang && v.lang.toLowerCase().startsWith('en'))
        .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const saved = localStorage.getItem('tts.enVoice');
      selEn.innerHTML = '';
      list.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.name+'||'+v.lang;
        opt.textContent=`${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if (saved && [...selEn.options].some(o=>o.value===saved)) selEn.value=saved;
      else if (list.length) selEn.value=list[0].value;
    }
    function getVoice(val){
      if(!val) return null;
      const [name,lang]=val.split('||');
      return voices.find(v=>v.name===name&&v.lang===lang) ||
             voices.find(v=>v.lang===lang) || null;
    }
    function speakEn(text){
      if(!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      const voice = getVoice(selEn.value);
      if (voice) u.voice = voice;
      u.rate = rate; u.pitch=1; u.volume=1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }
    rateEl.value = rate.toFixed(2);
    rateVal.textContent = rate.toFixed(2);
    rateEl.addEventListener('input', ()=>{
      rate = parseFloat(rateEl.value)||1;
      rateVal.textContent = rate.toFixed(2);
      localStorage.setItem('tts.rate', rate);
    });
    selEn.addEventListener('change', ()=>localStorage.setItem('tts.enVoice', selEn.value));
    loadVoices();
    if ('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = loadVoices;

    // ====== 讀檔與解析（關鍵：不要 trim 整行，以保留中文列的前導 tab） ======
    const theadRow = document.getElementById('theadRow');
    const tbody    = document.getElementById('tbody');

    fetch('/content/pronouns.txt?c='+Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt => {
        const {header, data} = parseTSV(txt);
        buildThead(header);
        render(data);
        loadInfo.textContent = `共 ${data.length} 組`;
      })
      .catch(err => loadInfo.textContent = '讀取失敗：' + err.message);

    function parseTSV(txt){
      // 不要 trim 每一行，避免吃掉中文列第一欄空白(tab)
      const rawLines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n');
      // 移除真正的空行（允許前導 tab 的中文行存在）
      const lines = rawLines.filter(l => l !== '' && l.replace(/\s/g,'') !== '');
      if (!lines.length) return {header:[], data:[]};

      const header = lines[0].split('\t').map(s=>s.trim());

      const data = [];
      for (let i=1;i<lines.length;i++){
        const enRaw = lines[i].split('\t');             // 保留空欄
        if (!enRaw[0]) continue; // 若第一欄空，這應是中文列，跳過
        const zhRaw = (i+1<lines.length) ? lines[i+1].split('\t') : [];
        const hasZh = zhRaw.length && zhRaw[0] === '';   // 中文列第一欄應為空字串

        if (hasZh) i++; // 吃掉中文列

        const en = enRaw.map(s=>s.trim());
        const zh = hasZh ? zhRaw.map(s=>s.trim()) : [];

        data.push({
          kind: en[0] || '',
          en:   [en[1]||'', en[2]||'', en[3]||'', en[4]||''],               // 主格 / 所有格 / 受格 / 所有代名詞
          zh:   hasZh ? [zh[1]||'', zh[2]||'', zh[3]||'', zh[4]||'']        // 我 / 我的 / 我 / 我的（等）
                      : ['', '', '', '']
        });
      }
      return {header, data};
    }

    function buildThead(header){
      theadRow.innerHTML='';
      header.forEach((h,idx)=>{
        const th = document.createElement('th');
        if (idx===0) th.className='kind';
        th.textContent = h || '';
        theadRow.appendChild(th);
      });
    }

    function render(rows){
      tbody.innerHTML='';
      rows.forEach(r=>{
        // 英文列：種類欄跨兩列
        const trEn = document.createElement('tr');
        const tdKind = document.createElement('td');
        tdKind.className='kind';
        tdKind.rowSpan = 2;
        tdKind.textContent = r.kind;
        trEn.appendChild(tdKind);

        r.en.forEach(val=>{
          const td=document.createElement('td');
          td.innerHTML = `<b>${escapeHTML(val)}</b>`;
          td.setAttribute('data-say', val);
          td.addEventListener('click', onSpeakCell);
          trEn.appendChild(td);
        });

        // 中文列（第一欄留空 → 由 tdKind 跨列佔住）
        const trZh = document.createElement('tr');
        trZh.className='cn';
        r.zh.forEach(val=>{
          const td=document.createElement('td');
          td.textContent = val;
          trZh.appendChild(td);
        });

        tbody.append(trEn, trZh);
      });
    }

    function onSpeakCell(e){
      const td = e.currentTarget;
      const text = td.getAttribute('data-say') || td.textContent.trim();
      if (!text) return;
      td.classList.add('speaking');
      speakEn(text);
      setTimeout(()=>td.classList.remove('speaking'), 300);
    }

    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  </script>
</body>
</html>
