<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KK 音標</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --col-w-letters: 28%;
      --col-w-symbol : 10%;
      --col-w-desc   : 30%;
      --col-w-words  : 32%;
      --navbar-h     : 56px;
      --tts-col-w    : 30%;
      --tts-gap      : .5rem;
    }

    html{scroll-behavior:smooth}
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}

    /* 控制列 */
    .tts-card{border:1px solid rgba(255,255,255,.25)}
    .tts-bar{display:flex;align-items:center;gap:var(--tts-gap);flex-wrap:nowrap;overflow:hidden}
    .tts-col{flex:0 0 var(--tts-col-w);min-width:0;display:flex;align-items:center;gap:.5rem}
    .tts-col label{flex:0 0 auto;white-space:nowrap}
    .tts-select{flex:1 1 auto;min-width:0;width:100%}

    /* 表格外框與固定版面 */
    .table-frame{border:1px solid rgba(255,255,255,.2);border-radius:.6rem;overflow:hidden}
    .table-frame .table{margin-bottom:0}
    .section-table{table-layout:fixed;width:100%}
    .section-table thead th{position:sticky;top:0;z-index:1;background:#1b1f22}

    /* 標題 */
    .h1-title{color:#fff;font-weight:700;font-size:1.05rem;margin:1rem 0 .4rem;scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h2-title{color:#ced4da;font-weight:600;font-size:.95rem;margin:.5rem 0 .6rem;scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h1-title,.h2-title{user-select:text}

    /* 欄寬 */
    .col-letters{width:var(--col-w-letters)}
    .col-symbol {width:var(--col-w-symbol)}
    .col-desc   {width:var(--col-w-desc)}
    .col-words  {width:var(--col-w-words)}

    /* 內容樣式與互動 */
    .section-table th, .section-table td{overflow:hidden;text-overflow:ellipsis}
    td.letters, th.th-letters{white-space:nowrap}
    td.symbol , th.th-symbol {white-space:nowrap}
    td.desc   , th.th-desc   {white-space:normal;word-break:break-word;color:#adb5bd}
    td.words{white-space:normal;word-break:break-word;position:relative}
    .word-group{display:flex;flex-wrap:wrap;gap:.35rem .6rem;padding-right:4.5rem}
    .pair{display:inline-flex;align-items:baseline;column-gap:.08rem}
    .pair .say-token{display:inline-block;padding:0 .1rem;border-radius:.25rem}
    .pair .note{display:inline;color:#6c757d;font-size:.9rem;cursor:default;padding:0}
    .pair .note:hover,.pair .note:active{background:transparent;transform:none}
    td[data-play], .say-token{cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease}
    td[data-play]:hover, .say-token:hover{background-color:rgba(255,255,255,.06)}
    td[data-play]:active, .say-token:active{transform:scale(1.03)}
    .playing{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    /* 每列切換按鈕 */
    .swap-btn{position:absolute;right:.35rem;top:.35rem;z-index:1}

    /* 章節目錄 */
    .dropdown-menu-dark{--bs-dropdown-bg:#1f2428;--bs-dropdown-link-active-bg:#0d6efd}
    .dropdown-menu{max-height:70vh; overflow:auto}
    .toc-h2{padding-left:1.5rem}

    @media (max-width:576px){
      :root{
        --col-w-letters:32%;
        --col-w-symbol :15%;
        --col-w-desc   :23%;
        --col-w-words  :30%;
        --tts-col-w    : 30%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">KK 音標</span>
      <a href="https://dictionary.cambridge.org/help/phonetics.html" target="_blank" rel="noopener">KK 音標(參考連結)</a>
      <div class="dropdown ms-auto">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="tocDropdown" data-bs-toggle="dropdown" aria-expanded="false">章節目錄</button>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="tocDropdown" id="tocMenu"></ul>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <!-- 控制列 -->
    <div class="card tts-card mb-3 bg-dark text-white">
      <div class="card-body py-2">
        <div class="tts-bar">
          <div class="tts-col">
            <label class="me-1">英</label>
            <select id="selEn" class="form-select form-select-sm tts-select bg-dark text-white border-secondary"></select>
          </div>
          <div class="tts-col">
            <label class="me-1">中</label>
            <select id="selZh" class="form-select form-select-sm tts-select bg-dark text-white border-secondary"></select>
          </div>
          <div class="tts-col">
            <label class="me-1">模式</label>
            <select id="modeSelect" class="form-select form-select-sm tts-select bg-dark text-white border-secondary">
              <option value="normal">正常</option>
              <option value="pron">發音</option>
              <option value="letters">字母</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="content"></div>
    <audio id="player" preload="auto"></audio>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====== 返回鍵 ======
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ====== 語音控制 ======
    const selEn = document.getElementById('selEn');
    const selZh = document.getElementById('selZh');
    const modeSelect = document.getElementById('modeSelect');
    let voices = [];
    function populateVoices(){
      voices = speechSynthesis.getVoices() || [];
      const listEn = voices.filter(v => v.lang && /^en/i.test(v.lang))
                           .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const listZhRaw = voices.filter(v => v.lang && /^zh/i.test(v.lang))
                              .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'zh'));
      const listZh = [...listZhRaw.filter(v=>/zh[-_]?TW/i.test(v.lang)), ...listZhRaw.filter(v=>!(/zh[-_]?TW/i.test(v.lang)))];

      const savedEn = localStorage.getItem('tts.enVoice');
      const savedZh = localStorage.getItem('tts.zhVoice');

      selEn.innerHTML = '';
      listEn.forEach(v=>{
        const opt=document.createElement('option');
        opt.value = v.name + '||' + v.lang;
        opt.textContent = `${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if (savedEn && [...selEn.options].some(o=>o.value===savedEn)) selEn.value = savedEn;
      else if (listEn.length) selEn.value = listEn[0].value;

      selZh.innerHTML = '';
      listZh.forEach(v=>{
        const opt=document.createElement('option');
        opt.value = v.name + '||' + v.lang;
        opt.textContent = `${v.name} (${v.lang})${v.default?' ★':''}`;
        selZh.appendChild(opt);
      });
      if (savedZh && [...selZh.options].some(o=>o.value===savedZh)) selZh.value = savedZh;
      else if (listZh.length) selZh.value = listZh[0].value;
    }
    function getSavedVoiceByKey(key, fallbackPrefix){
      const saved = localStorage.getItem(key);
      if (saved){
        const [name,lang] = saved.split('||');
        const v = voices.find(v=>v.name===name&&v.lang===lang);
        if (v) return v;
      }
      if (/^zh/i.test(fallbackPrefix)){
        return voices.find(v=>/zh[-_]?TW/i.test(v.lang)) || voices.find(v=>/^zh/i.test(v.lang)) || null;
      }
      return voices.find(v=>new RegExp('^'+fallbackPrefix,'i').test(v.lang)) || null;
    }
    selEn.addEventListener('change', ()=> localStorage.setItem('tts.enVoice', selEn.value));
    selZh.addEventListener('change', ()=> localStorage.setItem('tts.zhVoice', selZh.value));
    populateVoices();
    if ('onvoiceschanged' in speechSynthesis){ speechSynthesis.onvoiceschanged = populateVoices; }
    else { setTimeout(populateVoices, 400); }

    function getRoot(){
      const isGh = location.hostname.endsWith('github.io');
      const segs = location.pathname.split('/').filter(Boolean);
      const repo = isGh ? (segs[0] || '') : '';
      return location.origin + '/' + (repo ? repo + '/' : '');
    }

    // ====== 常數 ======
    const TXT_URL    = getRoot()+'content/kk.txt';
    const AUDIO_BASE = getRoot()+'audio/';
    const content    = document.getElementById('content');
    const tocMenu    = document.getElementById('tocMenu');
    const player     = document.getElementById('player');

    // ====== 模式（每次載入固定為 normal） ======
    let mode = 'normal';  // 'normal' | 'pron' | 'letters'
    modeSelect.value = 'normal';
    let parsedCache = [];

    function setMode(next){
      mode = next;
      modeSelect.value = mode;
      render(parsedCache, mode); // 依模式重繪
    }
    modeSelect.addEventListener('change', ()=> setMode(modeSelect.value));

    // ====== 載入資料 ======
    fetch(TXT_URL + '?c=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt => { parsedCache = parseAll(txt); render(parsedCache, mode); })
      .catch(err => {
        console.warn('讀取失敗，使用示例資料：', err);
        const demo =
`<1>（一）母音音標 #https://example.com/vowels;外部連結#
<2>單母音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
a\t[ æ ]\tkk.mp3\t0\t1.1\t短音的ㄟ\tcat [n.], hat
i\t[ ɪ ]\tkk.mp3\t1.2\t2.2\t短音的ㄧ\tit, ink [短音]
<2>雙母音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
ai\t[ aɪ ]\tkk.mp3\t2.3\t3.6\tㄞ\tbike [名詞], time
<1>（二）子音音標
<2>有聲子音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
b\t[ b ]\tkk.mp3\t3.7\t4.4\t有聲雙唇塞音\tbed, bad [反義]`;
        parsedCache = parseAll(demo);
        render(parsedCache, mode);
      });

    // ====== 解析 ======
    function parseAll(txt){
      const rawLines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n');
      const lines = rawLines.map(l => l.replace(/\s+$/,''));
      const items = [];
      for (const lineRaw of lines){
        const line = lineRaw.trim();
        if (!line) continue;

        const m1 = line.match(/^\s*<\s*1\s*>\s*(.+)$/);
        if (m1){ items.push({type:'h1', text: m1[1].trim()}); continue; }

        const m2 = line.match(/^\s*<\s*2\s*>\s*(.+)$/);
        if (m2){ items.push({type:'h2', text: m2[1].trim()}); continue; }

        if (!line.includes('\t')) continue;

        const cols = splitCols(line);
        if (isHeaderRow(cols)) continue;

        while (cols.length < 7) cols.push('');
        const [letters, symbol, mp3, start, end, desc, word] = cols;
        if (!(letters||symbol||mp3||start||end||desc||word)) continue;

        items.push({
          type:'row',
          letters: (letters||'').trim(),
          symbol:  (symbol||'').trim(),
          mp3:     (mp3||'').trim(),
          start:   parseFloat((start||'').trim()),
          end:     parseFloat((end||'').trim()),
          desc:    (desc||'').trim(),
          word:    (word||'').trim(),
        });
      }
      return items;
    }
    function splitCols(line){ return (line || '').split('\t').map(s => (s ?? '').trim()); }
    function normalizeKey(s){ return (s||'').replace(/[／/]/g,'/').replace(/\s+/g,'').toLowerCase(); }
    const HEADER_KEYS = new Set(['字母/字母組合','音標','mp3','start','end','發音','單字範例','單字','例字']);
    function isHeaderRow(cols){
      if (!cols || !cols.length) return false;
      const norm = cols.map(normalizeKey);
      return norm.filter(c => HEADER_KEYS.has(c)).length >= 2;
    }

    // ====== 繪製 ======
    function render(items, mode='normal'){
      content.innerHTML = '';
      tocMenu.innerHTML = '';
      let currentTbody = null;
      const tocItems = [];
      let h1Count = 0, h2Count = 0;

      items.forEach(it=>{
        if (it.type === 'h1'){
          const h = document.createElement('div');
          h.className = 'h1-title';
          const id = `h1-${++h1Count}`;
          h.id = id;
          h.innerHTML = parseLinks(it.text || '');
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 1});
          currentTbody = null;
          return;
        }
        if (it.type === 'h2'){
          const h = document.createElement('div');
          h.className = 'h2-title';
          const id = `h2-${++h2Count}`;
          h.id = id;
          h.innerHTML = parseLinks(it.text || '');
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 2});
          currentTbody = createSectionTable(mode);
          return;
        }
        if (it.type === 'row'){
          if (!currentTbody) currentTbody = createSectionTable(mode);
          currentTbody.appendChild(buildDataRow(it, mode));
        }
      });

      buildTOC(tocItems);
    }

    function createSectionTable(mode){
      const frame = document.createElement('div');
      frame.className = 'table-frame mb-3';

      const wrap = document.createElement('div');
      wrap.className = 'table-responsive m-0';
      frame.appendChild(wrap);

      const table = document.createElement('table');
      table.className = 'table table-dark table-hover align-middle section-table';

      // 表頭
      let headHtml = '';
      if (mode === 'pron'){
        headHtml = `
          <tr>
            <th class="th-letters">字母／字母組合</th>
            <th class="th-symbol">音標</th>
            <th class="th-words" colspan="2">單字範例</th>
          </tr>`;
      } else if (mode === 'letters'){
        headHtml = `
          <tr>
            <th class="th-symbol">音標</th>
            <th class="th-desc">發音</th>
            <th class="th-words" colspan="2">單字範例</th>
          </tr>`;
      } else {
        headHtml = `
          <tr>
            <th class="th-letters">字母／字母組合</th>
            <th class="th-symbol">音標</th>
            <th class="th-desc">發音</th>
            <th class="th-words">單字範例</th>
          </tr>`;
      }

      table.innerHTML = `
        <colgroup>
          <col class="col-letters">
          <col class="col-symbol">
          <col class="col-desc">
          <col class="col-words">
        </colgroup>
        <thead>${headHtml}</thead>
        <tbody></tbody>`;

      wrap.appendChild(table);
      content.appendChild(frame);
      return table.querySelector('tbody');
    }

    function buildDataRow(r, mode){
      const tr = document.createElement('tr');

      // 1) 字母
      const tdLetters = document.createElement('td');
      tdLetters.className = 'letters say-token';
      tdLetters.textContent = r.letters || '';
      if (r.letters){ tdLetters.addEventListener('click', ()=> sayZh(tdLetters, r.letters)); }
      tr.appendChild(tdLetters);

      // 2) 音標
      const tdSymbol = document.createElement('td');
      tdSymbol.className = 'symbol';
      tdSymbol.innerHTML = `<b>${escapeHTML(r.symbol || '')}</b>`;
      const src = resolveAudio(r.mp3);
      if (r.symbol && src && Number.isFinite(r.start) && Number.isFinite(r.end) && r.end > r.start){
        tdSymbol.dataset.playSrc   = src;
        tdSymbol.dataset.playStart = String(r.start);
        tdSymbol.dataset.playEnd   = String(r.end);
        tdSymbol.setAttribute('data-play','');
        tdSymbol.addEventListener('click', onPlayCell);
      }
      tr.appendChild(tdSymbol);

      // 3) 發音
      const tdDesc = document.createElement('td');
      tdDesc.className = 'desc say-token';
      tdDesc.innerHTML = parseLinks(r.desc || '');
      if (r.desc){
        tdDesc.addEventListener('click', (ev)=>{
          if (ev.target.closest('a')) return;
          sayZh(tdDesc, r.desc);
        });
      }
      tr.appendChild(tdDesc);

      // 4) 單字 + 每列切換
      const tdWord = document.createElement('td');
      tdWord.className = 'words';
      tdWord.appendChild(renderWordTokens(r.word || ''));

      if (mode === 'pron'){
        tdDesc.style.display = 'none';
        tdWord.colSpan = 2;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-light btn-sm swap-btn';
        btn.textContent = '切換';
        btn.title = '顯示/隱藏本列的【發音】';
        btn.setAttribute('data-toggle','desc');
        tdWord.appendChild(btn);
      } else if (mode === 'letters'){
        tdLetters.style.display = 'none';
        tdWord.colSpan = 2;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-outline-light btn-sm swap-btn';
        btn.textContent = '切換';
        btn.title = '顯示/隱藏本列的【字母】';
        btn.setAttribute('data-toggle','letters');
        tdWord.appendChild(btn);
      } else {
        tdWord.colSpan = 1;
      }

      tr.appendChild(tdWord);
      return tr;
    }

    // ====== 每列切換（只影響該列） ======
    content.addEventListener('click', (e)=>{
      const btn = e.target.closest('.swap-btn');
      if (!btn) return;

      const tr = btn.closest('tr');
      const kind = btn.getAttribute('data-toggle'); // 'desc' | 'letters'
      const tdWord = tr.querySelector('td.words');

      if (kind === 'desc'){
        const tdDesc = tr.querySelector('td.desc');
        const hidden = tdDesc.style.display === 'none' || getComputedStyle(tdDesc).display === 'none';
        tdDesc.style.display = hidden ? '' : 'none';
        tdWord.colSpan = hidden ? 1 : 2;
      } else if (kind === 'letters'){
        const tdLetters = tr.querySelector('td.letters');
        const hidden = tdLetters.style.display === 'none' || getComputedStyle(tdLetters).display === 'none';
        tdLetters.style.display = hidden ? '' : 'none';
        tdWord.colSpan = hidden ? 1 : 2;
      }
    });

    // ====== TOC ======
    function buildTOC(items){
      tocMenu.innerHTML = '';
      if (!items.length){
        const li = document.createElement('li');
        li.innerHTML = `<span class="dropdown-item-text text-secondary">（無章節）</span>`;
        tocMenu.appendChild(li);
        return;
      }
      items.forEach(({id, text, level})=>{
        const label = makeTOCLabel(text || '');
        if (!label) return;
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item' + (level === 2 ? ' toc-h2' : '');
        btn.textContent = label;
        btn.addEventListener('click', () => {
          const el = document.getElementById(id);
          if (el){ el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
          const ddEl = document.getElementById('tocDropdown');
          const dropdown = bootstrap.Dropdown.getInstance(ddEl) || new bootstrap.Dropdown(ddEl);
          dropdown.hide();
        });
        li.appendChild(btn);
        tocMenu.appendChild(li);
      });
    }
    function makeTOCLabel(raw){
      const noLinks = removeLinkBlocks(String(raw ?? ''));
      const idx1 = noLinks.indexOf('##');
      const idx2 = noLinks.indexOf('＃＃');
      const cut = (idx1 === -1) ? idx2 : (idx2 === -1 ? idx1 : Math.min(idx1, idx2));
      const head = cut >= 0 ? noLinks.slice(0, cut) : noLinks;
      return head.trim();
    }
    function removeLinkBlocks(s){
      let out = '';
      for (let i = 0; i < s.length; ){
        if (s[i] === '#'){
          const end = s.indexOf('#', i + 1);
          if (end !== -1){ i = end + 1; continue; }
        }
        out += s[i++];
      }
      return out;
    }

    // ====== 播放分段 ======
    let endTimer = null, lastOnTimeUpdate = null, currentPlayingEl = null;
    function onPlayCell(e){
      stopAll();
      const td = e.currentTarget;
      const src   = td.dataset.playSrc;
      const start = parseFloat(td.dataset.playStart);
      const end   = parseFloat(td.dataset.playEnd);
      if (!src || !Number.isFinite(start) || !Number.isFinite(end) || end<=start) return;

      currentPlayingEl = td;
      td.classList.add('playing');

      const go = ()=>{
        const seekAndPlay = ()=>{
          try{ player.currentTime = start; }catch{}
          player.play().catch(()=>{});
          lastOnTimeUpdate = ()=>{
            if (player.currentTime >= end - 0.02){ stopPlayback(); }
          };
          player.addEventListener('timeupdate', lastOnTimeUpdate);
          const dur = Math.max(0, (end - start) * 1000);
          endTimer = setTimeout(stopPlayback, dur + 60);
        };
        if (player.readyState >= 1) seekAndPlay();
        else player.addEventListener('loadedmetadata', seekAndPlay, {once:true});
      };

      if (player.src !== new URL(src, location.href).href){
        player.pause(); player.src = src; go();
      }else{ go(); }
    }
    function stopPlayback(){
      try{ player.pause(); }catch{}
      if (currentPlayingEl){ currentPlayingEl.classList.remove('playing'); currentPlayingEl = null; }
      if (lastOnTimeUpdate){ player.removeEventListener('timeupdate', lastOnTimeUpdate); lastOnTimeUpdate = null; }
      clearTimeout(endTimer); endTimer = null;
    }

    // ====== 單字 tokenization ======
    function splitWords(s){
      const unified = s.replace(/[ \u3000]/g,' ').replace(/[，、；;／/|]/g, ',');
      return unified.split(',').map(t => t.trim()).filter(t => t);
    }
    function renderWordTokens(s){
      const group = document.createElement('div');
      group.className = 'word-group';
      splitWords(s).forEach(seg=> tokenizeSegmentIntoPairs(seg, group));
      return group;
    }
    function tokenizeSegmentIntoPairs(segment, groupEl){
      const tokenRe = /\[[^\]]*\]/g;
      let lastIndex = 0, m;
      const tokens = [];
      while ((m = tokenRe.exec(segment)) !== null){
        if (m.index > lastIndex) tokens.push({type:'text', value: segment.slice(lastIndex, m.index)});
        tokens.push({type:'note', value: m[0]});
        lastIndex = m.index + m[0].length;
      }
      if (lastIndex < segment.length){
        tokens.push({type:'text', value: segment.slice(lastIndex)});
      }
      let lastPair = null;
      for (const tk of tokens){
        if (tk.type === 'text'){
          tk.value.split(/\s+/).map(w=>w.trim()).filter(Boolean).forEach(w=>{
            const pair = document.createElement('span');
            pair.className = 'pair';
            const word = document.createElement('span');
            word.className = 'say-token';
            word.textContent = w;
            word.addEventListener('click', ()=> sayEn(word, w));
            pair.appendChild(word);
            groupEl.appendChild(pair);
            lastPair = pair;
          });
        }else{
          const note = document.createElement('span');
          note.className = 'note';
          note.innerHTML = parseLinks(tk.value);
          if (lastPair){ lastPair.appendChild(note); }
          else{
            const pair = document.createElement('span');
            pair.className = 'pair';
            pair.appendChild(note);
            groupEl.appendChild(pair);
            lastPair = pair;
          }
        }
      }
    }

    // ====== 連結語法 ======
    function parseLinks(s){
      if (s == null) return '';
      const text = String(s);
      const pieces = [];
      let last = 0;
      const re = /#([^#\s][^#]*?)#/g;
      let m;
      while ((m = re.exec(text)) !== null){
        const before = text.slice(last, m.index);
        pieces.push(escapeHTML(before));
        const payload = m[1].trim();
        let url = payload, title = '';
        const semi = payload.indexOf(';');
        if (semi >= 0){ url = payload.slice(0, semi).trim(); title = payload.slice(semi + 1).trim(); }
        const disp = title || url;
        const a = `<a href="${attrEscape(url)}" target="_blank" rel="noopener">${escapeHTML(disp)}</a>`;
        pieces.push(a);
        last = m.index + m[0].length;
      }
      pieces.push(escapeHTML(text.slice(last)));
      return pieces.join('');
    }

    // ====== TTS ======
    function sayEn(el, text){ sayWithVoice(el, text, getSavedVoiceByKey('tts.enVoice','en'), 'en-US'); }
    function sayZh(el, text){ sayWithVoice(el, text, getSavedVoiceByKey('tts.zhVoice','zh'), 'zh-TW'); }
    function sayWithVoice(el, text, voice, fallbackLang){
      stopAll();
      if (!text) return;
      const u = new SpeechSynthesisUtterance(text);
      if (voice) u.voice = voice;
      u.lang = voice?.lang || fallbackLang || 'en-US';
      u.rate = 1.0; u.pitch=1; u.volume=1;
      el.classList.add('playing');
      u.onend = ()=> el.classList.remove('playing');
      u.onerror = ()=> el.classList.remove('playing');
      try{ speechSynthesis.cancel(); }catch{}
      speechSynthesis.speak(u);
    }

    // ====== 共用 ======
    function stopAll(){ stopPlayback(); try{ speechSynthesis.cancel(); }catch{} }
    function escapeHTML(s){
      return (s ?? '').replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));
    }
    function attrEscape(s){ return (String(s ?? '')).replace(/"/g,'&quot;'); }
    function resolveAudio(mp3){
      if (!mp3) return '';
      if (/^(https?:)?\/\//i.test(mp3) || mp3.startsWith('/')) return mp3;
      return AUDIO_BASE + mp3;
    }
  </script>
</body>
</html>





















