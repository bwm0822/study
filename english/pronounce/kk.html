<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KK 音標</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      /* ★ 全站統一欄寬（總和 100%）— 加大字母欄、縮小音標欄 */
      --col-w-letters: 28%;
      --col-w-symbol : 10%;
      --col-w-desc   : 30%;
      --col-w-words  : 32%;
      --navbar-h     : 56px; /* navbar 高度，供滾動定位 */
    }

    html{scroll-behavior:smooth}
    body{background:#212529;color:#f8f9fa}
    .navbar{border-bottom:1px solid rgba(255,255,255,.15)}

    /* ---- TTS 控制欄（外框 + 同一列 + 白字） ---- */
    .tts-card{border:1px solid rgba(255,255,255,.25)}
    .tts-bar{display:flex;align-items:center;gap:.8rem;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .range-inline{width:280px;min-width:200px}
    .tts-select{min-width:220px}

    /* ---- 外框只包表格，不含大小標題 ---- */
    .table-frame{border:1px solid rgba(255,255,255,.2);border-radius:.6rem;overflow:hidden}
    .table-frame .table{margin-bottom:0}

    /* 每個小節自己的表格，固定版面以對齊欄位 */
    .section-table{table-layout:fixed;width:100%}
    .section-table thead th{position:sticky;top:0;z-index:1;background:#1b1f22}

    /* 大小標題（不在外框內、無 hover），並預留滾動定位空間 */
    .h1-title{color:#fff;font-weight:700;font-size:1.05rem;margin:1rem 0 .4rem; scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h2-title{color:#ced4da;font-weight:600;font-size:.95rem;margin:.5rem 0 .6rem; scroll-margin-top:calc(var(--navbar-h) + 10px)}
    .h1-title,.h2-title{user-select:text}

    /* 統一欄寬（所有表格共用） */
    .col-letters{width:var(--col-w-letters)}
    .col-symbol {width:var(--col-w-symbol)}
    .col-desc   {width:var(--col-w-desc)}
    .col-words  {width:var(--col-w-words)}

    /* 防止內容溢出重疊（超出以省略號） */
    .section-table th, .section-table td{overflow:hidden;text-overflow:ellipsis}

    /* 欄位內容樣式 */
    td.letters{white-space:nowrap}
    td.symbol{white-space:nowrap}
    td.desc{color:#adb5bd;white-space:normal;word-break:break-word}
    td.words{white-space:normal;word-break:break-word}

    /* 互動（只在表格內作用） */
    td[data-play], .say-token{
      cursor:pointer;transition:transform .08s ease, background-color .2s ease, box-shadow .2s ease
    }
    td[data-play]:hover, .say-token:hover{background-color:rgba(255,255,255,.06)}
    td[data-play]:active, .say-token:active{transform:scale(1.03)}
    .playing{outline:2px solid var(--bs-primary);box-shadow:inset 0 0 0 .25rem rgba(var(--bs-primary-rgb),.2)}

    /* 單字範例欄位：一組(字+[])之間保留 gap；組內超貼 */
    .word-group{display:flex;flex-wrap:wrap;gap:.35rem .6rem}
    .pair{display:inline-flex;align-items:baseline;column-gap:.08rem}
    .pair .say-token{display:inline-block;padding:0 .1rem;border-radius:.25rem}
    .pair .note{display:inline;color:#6c757d;font-size:.9rem;cursor:default;padding:0}
    .pair .note:hover,.pair .note:active{background:transparent;transform:none}

    /* 章節目錄下拉（右上角） */
    .dropdown-menu-dark{--bs-dropdown-bg:#1f2428;--bs-dropdown-link-active-bg:#0d6efd}
    .dropdown-menu{max-height:70vh; overflow:auto}
    .toc-h2{padding-left:1.5rem}

    /* 小螢幕 */
    @media (max-width: 576px){
      :root{
        --col-w-letters: 32%;
        --col-w-symbol : 15%;
        --col-w-desc   : 23%;
        --col-w-words  : 30%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <button id="backBtn" class="btn btn-outline-light btn-sm">返回</button>
      <span class="navbar-brand ms-3 mb-0 h1">KK 音標</span>
      <a href="https://dictionary.cambridge.org/help/phonetics.html" target="_blank" rel="noopener">
          KK 音標(參考連結)
      </a>
      <!-- 右側：章節目錄 Dropdown（不改網址） -->
      <div class="dropdown ms-auto">
        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                id="tocDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          章節目錄
        </button>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="tocDropdown" id="tocMenu"></ul>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <!-- ★ 英/中 語音 + 語速 控制列（同一列，設定可儲存） -->
    <div class="card tts-card mb-3 bg-dark text-white">
      <div class="card-body py-2">
        <div class="tts-bar">
          <span class="me-1">語音(英)</span>
          <select id="selEn" class="form-select form-select-sm w-auto tts-select bg-dark text-white border-secondary"></select>

          <span>語音(中)</span>
          <select id="selZh" class="form-select form-select-sm w-auto tts-select bg-dark text-white border-secondary"></select>

          <span>語速</span><span id="rateVal">1.00</span>
          <input id="rate" type="range" class="form-range range-inline" min="0.5" max="2.0" step="0.05" value="1.00" />
        </div>
      </div>
    </div>

    <div id="content"></div>
    <audio id="player" preload="auto"></audio>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== 返回鍵 ======
    document.getElementById('backBtn').addEventListener('click', ()=>history.back());

    // ====== TTS 控制（UI + 永續存取） ======
    const selEn   = document.getElementById('selEn');
    const selZh   = document.getElementById('selZh');
    const rateEl  = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    let voices = [];

    function populateVoices(){
      voices = speechSynthesis.getVoices() || [];
      const listEn = voices.filter(v => v.lang && /^en/i.test(v.lang))
                           .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'en'));
      const listZhRaw = voices.filter(v => v.lang && /^zh/i.test(v.lang))
                              .sort((a,b)=>(a.lang+a.name).localeCompare(b.lang+b.name,'zh'));
      const listZh = [...listZhRaw.filter(v=>/zh[-_]?TW/i.test(v.lang)), ...listZhRaw.filter(v=>!(/zh[-_]?TW/i.test(v.lang)))];

      const savedEn = localStorage.getItem('tts.enVoice');
      const savedZh = localStorage.getItem('tts.zhVoice');

      selEn.innerHTML = '';
      listEn.forEach(v=>{
        const opt=document.createElement('option');
        opt.value = v.name + '||' + v.lang;
        opt.textContent = `${v.name} (${v.lang})${v.default?' ★':''}`;
        selEn.appendChild(opt);
      });
      if (savedEn && [...selEn.options].some(o=>o.value===savedEn)) selEn.value = savedEn;
      else if (listEn.length) selEn.value = listEn[0].value;

      selZh.innerHTML = '';
      listZh.forEach(v=>{
        const opt=document.createElement('option');
        opt.value = v.name + '||' + v.lang;
        opt.textContent = `${v.name} (${v.lang})${v.default?' ★':''}`;
        selZh.appendChild(opt);
      });
      if (savedZh && [...selZh.options].some(o=>o.value===savedZh)) selZh.value = savedZh;
      else if (listZh.length) selZh.value = listZh[0].value;
    }

    function getSavedVoiceByKey(key, fallbackPrefix){
      const saved = localStorage.getItem(key);
      if (saved){
        const [name,lang] = saved.split('||');
        const v = voices.find(v=>v.name===name&&v.lang===lang);
        if (v) return v;
      }
      if (/^zh/i.test(fallbackPrefix)){
        return voices.find(v=>/zh[-_]?TW/i.test(v.lang))
            || voices.find(v=>/^zh/i.test(v.lang))
            || null;
      }
      return voices.find(v=>new RegExp('^'+fallbackPrefix,'i').test(v.lang)) || null;
    }

    function getSavedRate(){
      const r = parseFloat(localStorage.getItem('tts.rate') || '1');
      return isNaN(r) ? 1 : r;
    }

    (function initRate(){
      const r = getSavedRate();
      rateEl.value = r.toFixed(2);
      rateVal.textContent = r.toFixed(2);
    })();
    rateEl.addEventListener('input', ()=>{
      const r = parseFloat(rateEl.value) || 1;
      rateVal.textContent = r.toFixed(2);
      localStorage.setItem('tts.rate', r);
    });
    selEn.addEventListener('change', ()=> localStorage.setItem('tts.enVoice', selEn.value));
    selZh.addEventListener('change', ()=> localStorage.setItem('tts.zhVoice', selZh.value));

    populateVoices();
    if ('onvoiceschanged' in speechSynthesis){
      speechSynthesis.onvoiceschanged = populateVoices;
    } else {
      setTimeout(populateVoices, 400);
    }

    function getRoot() 
    {
      const isGh = location.hostname.endsWith('github.io');
      const segs = location.pathname.split('/').filter(Boolean);
      const repo = isGh ? (segs[0] || '') : '';
      // 例：
      // - localhost:  return 'http://localhost:3000/'
      // - GH Pages:   return 'https://bwm0822.github.io/study/'
      return location.origin + '/' + (repo ? repo + '/' : '');
    }

    // ====== 常數（內容解析） ======
    const TXT_URL    = getRoot()+'content/kk.txt';   // Tab：字母/音標/mp3/start/end/發音/單字範例
    const AUDIO_BASE = 'audio/';

    const content  = document.getElementById('content');
    const tocMenu  = document.getElementById('tocMenu');
    const player   = document.getElementById('player');

    // ====== 讀取檔案 ======
    fetch(TXT_URL + '?c=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt => { render(parseAll(txt)); })
      .catch(err => {
        console.warn('讀取失敗，使用示例資料：', err);
        const demo =
`<1>（一）母音音標 #https://example.com/vowels;外部連結#
<2>單母音 ## TOC 不顯示這段
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
a\t[ æ ]\tkk.mp3\t0\t1.1\t短音的ㄟ\tcat [n.], hat
i\t[ ɪ ]\tkk.mp3\t1.2\t2.2\t短音的ㄧ\tit, ink [短音]

<2>雙母音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
ai\t[ aɪ ]\tkk.mp3\t2.3\t3.6\tㄞ\tbike [名詞], time

<1>（二）子音音標
<2>有聲子音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
b\t[ b ]\tkk.mp3\t3.7\t4.4\t有聲雙唇塞音\tbed, bad [反義]

<2>無聲子音
字母／字母組合\t音標\tmp3\tstart\tend\t發音\t單字範例
p\t[ p ]\tkk.mp3\t4.5\t5.3\t清雙唇塞音\tpen [n.], pie

<1>#https://english.cool/places-prepositions/;地方介系詞#  ## 這個 H1 在頁面顯示為連結，但 TOC 會整項被省略（因為只有連結）`;
        render(parseAll(demo));
      });

    // ====== 解析：任意位置的 <1>/<2> 與資料列 ======
    function parseAll(txt){
      const rawLines = txt.replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n');
      const lines = rawLines.map(l => l.replace(/\s+$/,''));
      const items = [];
      for (const lineRaw of lines){
        const line = lineRaw.trim();
        if (!line) continue;

        const m1 = line.match(/^\s*<\s*1\s*>\s*(.+)$/);
        if (m1){ items.push({type:'h1', text: m1[1].trim()}); continue; }

        const m2 = line.match(/^\s*<\s*2\s*>\s*(.+)$/);
        if (m2){ items.push({type:'h2', text: m2[1].trim()}); continue; }

        if (!line.includes('\t')) continue;

        const cols = splitCols(line);
        if (isHeaderRow(cols)) continue;

        while (cols.length < 7) cols.push('');
        const [letters, symbol, mp3, start, end, desc, word] = cols;

        if (!(letters||symbol||mp3||start||end||desc||word)) continue;

        items.push({
          type:'row',
          letters: (letters||'').trim(),
          symbol:  (symbol||'').trim(),
          mp3:     (mp3||'').trim(),
          start:   parseFloat((start||'').trim()),
          end:     parseFloat((end||'').trim()),
          desc:    (desc||'').trim(),
          word:    (word||'').trim(),
        });
      }
      return items;
    }

    // ---- 輔助：拆欄、表頭判斷 ----
    function splitCols(line){ return (line || '').split('\t').map(s => (s ?? '').trim()); }
    function normalizeKey(s){ return (s||'').replace(/[／/]/g,'/').replace(/\s+/g,'').toLowerCase(); }
    const HEADER_KEYS = new Set(['字母/字母組合','音標','mp3','start','end','發音','單字範例','單字','例字']);
    function isHeaderRow(cols){
      if (!cols || !cols.length) return false;
      const norm = cols.map(normalizeKey);
      return norm.filter(c => HEADER_KEYS.has(c)).length >= 2;
    }

    // ====== 建一個新小節表格 ======
    function createSectionTable(){
      const frame = document.createElement('div');
      frame.className = 'table-frame mb-3';

      const wrap = document.createElement('div');
      wrap.className = 'table-responsive m-0';
      frame.appendChild(wrap);

      const table = document.createElement('table');
      table.className = 'table table-dark table-hover align-middle section-table';
      table.innerHTML = `
        <colgroup>
          <col class="col-letters"><col class="col-symbol"><col class="col-desc"><col class="col-words">
        </colgroup>
        <thead>
          <tr>
            <th>字母／字母組合</th>
            <th>音標</th>
            <th>發音</th>
            <th>單字範例</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      wrap.appendChild(table);

      content.appendChild(frame);
      return table.querySelector('tbody');
    }

    // ====== TOC：忽略所有 #...# 連結片段，並裁掉第一個（可含全形）"##" 之後 ======
    function buildTOC(items){
      tocMenu.innerHTML = '';
      if (!items.length){
        const li = document.createElement('li');
        li.innerHTML = `<span class="dropdown-item-text text-secondary">（無章節）</span>`;
        tocMenu.appendChild(li);
        return;
      }
      items.forEach(({id, text, level})=>{
        const label = makeTOCLabel(text || '');
        if (!label) return; // 若整段只有連結或被裁空，這項不進 TOC

        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item' + (level === 2 ? ' toc-h2' : '');
        btn.textContent = label; // 用 textContent，避免 HTML
        btn.addEventListener('click', () => {
          const el = document.getElementById(id);
          if (el){ el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
          const ddEl = document.getElementById('tocDropdown');
          const dropdown = bootstrap.Dropdown.getInstance(ddEl) || new bootstrap.Dropdown(ddEl);
          dropdown.hide();
        });
        li.appendChild(btn);
        tocMenu.appendChild(li);
      });
    }

    // 產生 TOC 顯示字串：去掉所有 #...#，再裁掉第一個 "##" 或 "＃＃" 之後
    function makeTOCLabel(raw){
      const noLinks = removeLinkBlocks(String(raw ?? ''));
      const idx1 = noLinks.indexOf('##');
      const idx2 = noLinks.indexOf('＃＃'); // 全形
      const cut = (idx1 === -1) ? idx2 : (idx2 === -1 ? idx1 : Math.min(idx1, idx2));
      const head = cut >= 0 ? noLinks.slice(0, cut) : noLinks;
      return head.trim();
    }

    // 把 #...# 片段整段移除（含 #URL;標題# 或 #URL#）
    function removeLinkBlocks(s){
      let out = '';
      for (let i = 0; i < s.length; ){
        if (s[i] === '#'){
          const end = s.indexOf('#', i + 1);
          if (end !== -1){
            i = end + 1; // 跳過整個 #...#
            continue;
          }
        }
        out += s[i++];
      }
      return out;
    }

    // ====== 繪製（標題保留連結；TOC 省略連結） ======
    function render(items){
      content.innerHTML = '';
      tocMenu.innerHTML = '';
      let currentTbody = null;
      const tocItems = [];
      let h1Count = 0, h2Count = 0;

      items.forEach(it=>{
        if (it.type === 'h1'){
          const h = document.createElement('div');
          h.className = 'h1-title';
          const id = `h1-${++h1Count}`;
          h.id = id;
          h.innerHTML = parseLinks(it.text || ''); // 頁面上保留連結
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 1});
          currentTbody = null;
          return;
        }
        if (it.type === 'h2'){
          const h = document.createElement('div');
          h.className = 'h2-title';
          const id = `h2-${++h2Count}`;
          h.id = id;
          h.innerHTML = parseLinks(it.text || ''); // 頁面上保留連結
          content.appendChild(h);
          tocItems.push({id, text: it.text || '', level: 2});
          currentTbody = createSectionTable();
          return;
        }
        if (it.type === 'row'){
          if (!currentTbody){
            currentTbody = createSectionTable();
          }
          currentTbody.appendChild(buildDataRow(it));
        }
      });

      buildTOC(tocItems);
    }

    // ====== 資料列 ======
    function buildDataRow(r){
      const tr = document.createElement('tr');

      // 字母／字母組合（點擊 -> 中文發音）
      const tdLetters = document.createElement('td');
      tdLetters.className = 'letters say-token';
      tdLetters.textContent = r.letters || '';
      if (r.letters){
        tdLetters.addEventListener('click', ()=> sayZh(tdLetters, r.letters));
      }
      tr.appendChild(tdLetters);

      // 音標（可點擊播放片段）
      const tdSymbol = document.createElement('td');
      tdSymbol.className = 'symbol';
      tdSymbol.innerHTML = `<b>${escapeHTML(r.symbol || '')}</b>`;
      const src = resolveAudio(r.mp3);
      if (r.symbol && src && Number.isFinite(r.start) && Number.isFinite(r.end) && r.end > r.start){
        tdSymbol.dataset.playSrc   = src;
        tdSymbol.dataset.playStart = String(r.start);
        tdSymbol.dataset.playEnd   = String(r.end);
        tdSymbol.setAttribute('data-play','');
        tdSymbol.addEventListener('click', onPlayCell);
      }
      tr.appendChild(tdSymbol);

      // 發音（點擊 -> 中文發音；支援 #URL;標題# 連結，點連結不觸發朗讀）
      const tdDesc = document.createElement('td');
      tdDesc.className = 'desc say-token';
      tdDesc.innerHTML = parseLinks(r.desc || '');
      if (r.desc){
        tdDesc.addEventListener('click', (ev)=>{
          if (ev.target.closest('a')) return;
          sayZh(tdDesc, r.desc);
        });
      }
      tr.appendChild(tdDesc);

      // 單字範例（英文字 -> 英文發音；備註可含 #URL;標題#）
      const tdWord = document.createElement('td');
      tdWord.className = 'words';
      tdWord.appendChild(renderWordTokens(r.word || ''));
      tr.appendChild(tdWord);

      return tr;
    }

    // ====== 音標分段播放 ======
    let endTimer = null;
    let lastOnTimeUpdate = null;
    let currentPlayingEl = null;

    function onPlayCell(e){
      stopAll();
      const td = e.currentTarget;
      const src   = td.dataset.playSrc;
      const start = parseFloat(td.dataset.playStart);
      const end   = parseFloat(td.dataset.playEnd);
      if (!src || !Number.isFinite(start) || !Number.isFinite(end) || end<=start) return;

      currentPlayingEl = td;
      td.classList.add('playing');

      const go = ()=>{
        const seekAndPlay = ()=>{
          try{ player.currentTime = start; }catch{}
          player.play().catch(()=>{});
          lastOnTimeUpdate = ()=>{
            if (player.currentTime >= end - 0.02){
              stopPlayback();
            }
          };
          player.addEventListener('timeupdate', lastOnTimeUpdate);
          const dur = Math.max(0, (end - start) * 1000);
          endTimer = setTimeout(stopPlayback, dur + 60);
        };
        if (player.readyState >= 1) seekAndPlay();
        else player.addEventListener('loadedmetadata', seekAndPlay, {once:true});
      };

      if (player.src !== new URL(src, location.href).href){
        player.pause();
        player.src = src;
        go();
      }else{
        go();
      }
    }

    function stopPlayback(){
      try{ player.pause(); }catch{}
      if (currentPlayingEl){ currentPlayingEl.classList.remove('playing'); currentPlayingEl = null; }
      if (lastOnTimeUpdate){ player.removeEventListener('timeupdate', lastOnTimeUpdate); lastOnTimeUpdate = null; }
      clearTimeout(endTimer); endTimer = null;
    }

    // ====== 單字範例 tokenization ======
    function splitWords(s){
      const unified = s.replace(/[ \u3000]/g,' ').replace(/[，、；;／/|]/g, ',');
      return unified.split(',').map(t => t.trim()).filter(t => t);
    }

    function renderWordTokens(s){
      const group = document.createElement('div');
      group.className = 'word-group';
      splitWords(s).forEach(seg=> tokenizeSegmentIntoPairs(seg, group));
      return group;
    }

    function tokenizeSegmentIntoPairs(segment, groupEl){
      const tokenRe = /\[[^\]]*\]/g;
      let lastIndex = 0, m;
      const tokens = [];
      while ((m = tokenRe.exec(segment)) !== null){
        if (m.index > lastIndex) tokens.push({type:'text', value: segment.slice(lastIndex, m.index)});
        tokens.push({type:'note', value: m[0]});
        lastIndex = m.index + m[0].length;
      }
      if (lastIndex < segment.length) tokens.push({type:'text', value: segment.slice(lastIndex)});

      let lastPair = null;
      for (const tk of tokens){
        if (tk.type === 'text'){
          tk.value.split(/\s+/).map(w=>w.trim()).filter(Boolean).forEach(w=>{
            const pair = document.createElement('span');
            pair.className = 'pair';
            const word = document.createElement('span');
            word.className = 'say-token';
            word.textContent = w;
            word.addEventListener('click', ()=> sayEn(word, w));
            pair.appendChild(word);
            groupEl.appendChild(pair);
            lastPair = pair;
          });
        }else{
          const note = document.createElement('span');
          note.className = 'note';
          note.innerHTML = parseLinks(tk.value);
          if (lastPair){ lastPair.appendChild(note); }
          else{
            const pair = document.createElement('span');
            pair.className = 'pair';
            pair.appendChild(note);
            groupEl.appendChild(pair);
            lastPair = pair;
          }
        }
      }
    }

    // ====== 連結語法：#URL;標題# / #URL#（頁面上顯示；TOC 已省略） ======
    function parseLinks(s){
      if (s == null) return '';
      const text = String(s);

      const pieces = [];
      let last = 0;
      const re = /#([^#\s][^#]*?)#/g; // 介於兩個 # 之間，且非空
      let m;
      while ((m = re.exec(text)) !== null){
        const before = text.slice(last, m.index);
        pieces.push(escapeHTML(before));

        const payload = m[1].trim();
        let url = payload;
        let title = '';
        const semi = payload.indexOf(';');
        if (semi >= 0){
          url = payload.slice(0, semi).trim();
          title = payload.slice(semi + 1).trim();
        }

        const disp = title || url;
        const a = `<a href="${attrEscape(url)}" target="_blank" rel="noopener">${escapeHTML(disp)}</a>`;
        pieces.push(a);
        last = m.index + m[0].length;
      }
      pieces.push(escapeHTML(text.slice(last)));
      return pieces.join('');
    }

    // ====== TTS（英/中；讀取 UI 設定） ======
    function sayEn(el, text){ sayWithVoice(el, text, getSavedVoiceByKey('tts.enVoice','en'), 'en-US'); }
    function sayZh(el, text){ sayWithVoice(el, text, getSavedVoiceByKey('tts.zhVoice','zh'), 'zh-TW'); }
    function sayWithVoice(el, text, voice, fallbackLang){
      stopAll();
      if (!text) return;
      const u = new SpeechSynthesisUtterance(text);
      if (voice) u.voice = voice;
      u.lang = voice?.lang || fallbackLang || 'en-US';
      u.rate = getSavedRate();
      u.pitch=1; u.volume=1;

      el.classList.add('playing');
      u.onend = ()=> el.classList.remove('playing');
      u.onerror = ()=> el.classList.remove('playing');

      try{ speechSynthesis.cancel(); }catch{}
      speechSynthesis.speak(u);
    }

    // ====== 共用 ======
    function stopAll(){ stopPlayback(); try{ speechSynthesis.cancel(); }catch{} }
    function escapeHTML(s){ return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function attrEscape(s){ return (String(s??'')).replace(/"/g,'&quot;'); }
    function resolveAudio(mp3){
      if (!mp3) return '';
      if (/^(https?:)?\/\//i.test(mp3) || mp3.startsWith('/')) return mp3;
      return AUDIO_BASE + mp3;
    }
  </script>
</body>
</html>








